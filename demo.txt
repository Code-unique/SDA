this is demo






You are a senior full-stack engineer with deep knowledge of Next.js, React, Prisma/Mongoose models, API routes, types, server actions, and component data flow.

I will paste my entire relevant project files separated using ‚Äú--------------‚Äù.
These include:
- admin/courses/create
- admin/courses/*
- app/courses/[slug]/page
- Typescript models & interfaces in /types
- Database models in /models (Prisma or Mongoose; understand from code)
- Any API endpoints used for modules, lessons, or courses
- Components under /components that load lessons/modules
- Utility files if used for course building

Your job is to **update my existing files exactly**, NOT create a new project.  
Modify only what is needed to implement the new data structure:

========================================
### üî• NEW required architecture (mandatory)
Course ‚Üí Module ‚Üí Chapter ‚Üí Lesson

Lessons previously belonged directly to modules.  
Now they must belong inside chapters.

### Module (updated)
- id
- courseId
- name
- description
- order
- thumbnailUrl (NEW FIELD)
- has many Chapters

### Chapter (NEW MODEL)
- id
- moduleId
- name
- description
- order
- has many Lessons

### Lesson (updated)
- id
- chapterId (required)
- name
- description
- videoUrl
- order

========================================
### üî• Admin UI updates required
Update ALL admin pages/forms to support:
- Creating and editing Modules with thumbnailUrl
- Creating Chapters inside Modules
- Creating Lessons inside Chapters
- Drag-and-drop or ordering if already supported
- Showing nested structure visually:
      Module
        ‚Üí Chapter
            ‚Üí Lessons

### Admin pages affected:
- admin/courses/create
- admin/courses/[id]/*
- any module/lesson UI under admin

========================================
### üî• Frontend course display updates required
`app/courses/[slug]/page.tsx`  
and any other pages must now load:

Course ‚Üí Modules ‚Üí Chapters ‚Üí Lessons

And render them in hierarchical order.

========================================
### üî• Typescript & model updates required
Update ALL:
- /types/*.ts
- /models/*.ts or schema.prisma
- /lib/db
- API routes
- Server actions (if used)

========================================
### üî• Migration script required
Because lessons previously belonged directly to a module, include a migration file:

`scripts/migrate-lessons-to-chapters.js`

Migration requirements:
- Find lessons that have moduleId but no chapterId
- Create a default chapter for each module (e.g., ‚ÄúGeneral‚Äù)
- Move those lessons into the new chapter
- Log all changes

========================================
### üî• API routes / server actions required
Update or create:
- /api/modules/*
- /api/chapters/*
- /api/lessons/*

Including:
- GET full module with chapters + lessons
- GET full course structure
- CRUD for modules ‚Üí chapters ‚Üí lessons

========================================
### üî• Important instructions
When I paste files, you must:

1. Read & understand my architecture automatically (Prisma, Mongo, etc.)
2. Modify only the necessary parts
3. Preserve my component structure & naming
4. Add imports wherever needed
5. Output updated files in the EXACT format:

      -------------- <file-path>
      <updated full file content>

6. DO NOT generate theoretical, placeholder, or simplified code.
   Produce **real working code** that matches my framework & code style.

7. DO NOT create new files unless required (e.g., NEW Chapter model, migration script).
8. DO NOT break existing logic or remove features unless necessary.


ask for files with  name if anyfurther code is required....

-------------------------------
// types/course.ts

export interface S3Asset {
  key: string
  url: string
  size: number
  type: 'image' | 'video'
  duration?: number
  width?: number
  height?: number
}

export interface UploadProgress {
  [key: string]: {
    progress: number
    fileName: string
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo'
    status: 'generating-url' | 'uploading' | 'processing' | 'completed' | 'error'
    error?: string
  }
}

export interface LessonResource {
  title: string
  url: string
  type: 'pdf' | 'document' | 'link' | 'video'
}

export interface Lesson {
  _id?: string
  title: string
  description: string
  content: string
  video?: S3Asset
  duration: number
  isPreview: boolean
  resources: LessonResource[]
  order: number
}

export interface Module {
  _id?: string
  title: string
  description: string
  lessons: Lesson[]
  order: number
}

export interface CourseInstructor {
  _id: string
  firstName: string
  lastName: string
  username: string
  avatar?: string
}

export interface Course {
  _id: string
  title: string
  description: string
  shortDescription: string
  slug: string
  instructor: CourseInstructor
  price: number
  isFree: boolean
  level: 'beginner' | 'intermediate' | 'advanced'
  category: string
  tags: string[]
  thumbnail: S3Asset | null
  previewVideo: S3Asset | null
  modules: Module[]
  requirements: string[]
  learningOutcomes: string[]
  isPublished: boolean
  isFeatured: boolean
  totalStudents: number
  averageRating: number
  totalDuration: number
  totalLessons: number
  createdAt: string
  updatedAt: string
}
-----------------------------------------------
// lib/models/Course.ts
import mongoose, { Document, Schema, Model } from 'mongoose';

// S3 Asset Interface
export interface IS3Asset {
  key: string;
  url: string;
  size: number;
  type: 'image' | 'video';
  duration?: number;
  width?: number;
  height?: number;
}

export interface ILessonResource {
  title: string;
  url: string;
  type: 'pdf' | 'document' | 'link' | 'video';
}

export interface ILesson {
  _id?: mongoose.Types.ObjectId;
  title: string;
  description: string;
  content: string;
  video: IS3Asset;
  duration: number;
  isPreview: boolean;
  resources: ILessonResource[];
  order: number;
}

export interface IModule {
  _id?: mongoose.Types.ObjectId;
  title: string;
  description: string;
  lessons: ILesson[];
  order: number;
}

export interface IRating {
  _id?: mongoose.Types.ObjectId;
  user: mongoose.Types.ObjectId;
  rating: number;
  review?: string;
  createdAt: Date;
  updatedAt?: Date;
}

export interface IStudentProgress {
  user: mongoose.Types.ObjectId;
  enrolledAt: Date;
  progress: number;
  completed: boolean;
  completedAt?: Date;
  paymentMethod?: string;
  paymentAmount?: number;
  enrolledThrough?: string;
}

export interface ICourse extends Document {
  title: string;
  slug: string;
  description: string;
  shortDescription: string;
  instructor: mongoose.Types.ObjectId;
  price: number;
  isFree: boolean;
  level: 'beginner' | 'intermediate' | 'advanced';
  category: string;
  tags: string[];
  thumbnail: IS3Asset;
  previewVideo?: IS3Asset;
  modules: IModule[];
  ratings: IRating[];
  students: IStudentProgress[];
  totalStudents: number;
  averageRating: number;
  totalDuration: number;
  totalLessons: number;
  isPublished: boolean;
  isFeatured: boolean;
  requirements: string[];
  learningOutcomes: string[];
  createdAt: Date;
  updatedAt: Date;
}

// S3 Asset Schema
const S3AssetSchema = new Schema<IS3Asset>({
  key: { type: String, required: true },
  url: { type: String, required: true },
  size: { type: Number, required: true },
  type: { type: String, enum: ['image', 'video'], required: true },
  duration: Number,
  width: Number,
  height: Number
});

const LessonResourceSchema = new Schema<ILessonResource>({
  title: { type: String, required: true },
  url: { type: String, required: true },
  type: { type: String, enum: ['pdf', 'document', 'link', 'video'], required: true }
});

const LessonSchema = new Schema<ILesson>({
  title: { type: String, required: true, maxlength: 200 },
  description: { type: String, required: true, maxlength: 1000 },
  content: { type: String, required: true },
  video: { type: S3AssetSchema, required: true },
  duration: { type: Number, default: 0, min: 0, max: 10000 },
  isPreview: { type: Boolean, default: false },
  resources: [LessonResourceSchema],
  order: { type: Number, required: true, min: 0 }
});

const ModuleSchema = new Schema<IModule>({
  title: { type: String, required: true, maxlength: 200 },
  description: { type: String, required: true, maxlength: 1000 },
  lessons: [LessonSchema],
  order: { type: Number, required: true, min: 0 }
});

const RatingSchema = new Schema<IRating>({
  user: { type: Schema.Types.ObjectId, ref: 'User', required: true },
  rating: { type: Number, required: true, min: 1, max: 5 },
  review: { type: String, maxlength: 1000 },
  createdAt: { type: Date, default: Date.now }
});

const StudentProgressSchema = new Schema<IStudentProgress>({
  user: { type: Schema.Types.ObjectId, ref: 'User', required: true },
  enrolledAt: { type: Date, default: Date.now },
  progress: { type: Number, default: 0, min: 0, max: 1 },
  completed: { type: Boolean, default: false },
  completedAt: Date,
  paymentMethod: String,
  paymentAmount: Number,
  enrolledThrough: String
});

const CourseSchema = new Schema<ICourse>(
  {
    title: {
      type: String,
      required: true,
      trim: true,
      maxlength: 100
    },
    slug: {
      type: String,
      required: true,
      unique: true,
      lowercase: true
    },
    description: {
      type: String,
      required: true
    },
    shortDescription: {
      type: String,
      required: true,
      maxlength: 200
    },
    instructor: {
      type: Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },
    price: {
      type: Number,
      default: 0,
      min: 0
    },
    isFree: {
      type: Boolean,
      default: false
    },
    level: {
      type: String,
      enum: ['beginner', 'intermediate', 'advanced'],
      required: true
    },
    category: {
      type: String,
      required: true,
      maxlength: 50
    },
    tags: [{
      type: String,
      maxlength: 30
    }],
    thumbnail: {
      type: S3AssetSchema,
      required: true
    },
    previewVideo: S3AssetSchema,
    modules: [ModuleSchema],
    ratings: [RatingSchema],
    students: [StudentProgressSchema],
    totalStudents: {
      type: Number,
      default: 0,
      min: 0
    },
    averageRating: {
      type: Number,
      default: 0,
      min: 0,
      max: 5
    },
    totalDuration: {
      type: Number,
      default: 0,
      min: 0
    },
    totalLessons: {
      type: Number,
      default: 0,
      min: 0
    },
    isPublished: {
      type: Boolean,
      default: false
    },
    isFeatured: {
      type: Boolean,
      default: false
    },
    requirements: [{
      type: String,
      maxlength: 200
    }],
    learningOutcomes: [{
      type: String,
      maxlength: 200
    }]
  },
  {
    timestamps: true
  }
);

// Pre-save middleware for auto-calculated fields
CourseSchema.pre('save', function (next) {
  const course = this as ICourse;

  // Calculate total lessons
  course.totalLessons = course.modules.reduce((total, module) =>
    total + module.lessons.length, 0
  );

  // Calculate total duration
  course.totalDuration = course.modules.reduce((total, module) =>
    total + module.lessons.reduce((moduleTotal, lesson) =>
      moduleTotal + (lesson.duration || 0), 0
    ), 0
  );

  // Generate slug if not provided or title changed
  if (this.isModified('title') || !course.slug) {
    course.slug = course.title
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .trim()
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .substring(0, 100);
  }

  // Update average rating if ratings changed
  if (this.isModified('ratings') && course.ratings.length > 0) {
    const sum = course.ratings.reduce((total, rating) => total + rating.rating, 0);
    course.averageRating = Math.round((sum / course.ratings.length) * 10) / 10;
  }

  next();
});

// Indexes for better query performance
CourseSchema.index({ instructor: 1 });
CourseSchema.index({ isPublished: 1, isFeatured: 1 });
CourseSchema.index({ category: 1 });
CourseSchema.index({ 'students.user': 1 });
CourseSchema.index({ createdAt: -1 });


// Static method to find published courses
CourseSchema.statics.findPublished = function () {
  return this.find({ isPublished: true });
};

// Instance method to add a student
CourseSchema.methods.addStudent = function (userId: mongoose.Types.ObjectId) {
  const course = this as ICourse;
  const existingStudent = course.students.find(student =>
    student.user.toString() === userId.toString()
  );

  if (!existingStudent) {
    course.students.push({
      user: userId,
      enrolledAt: new Date(),
      progress: 0,
      completed: false
    } as IStudentProgress);
    course.totalStudents += 1;
  }

  return this.save();
};

// Define the model interface
interface ICourseModel extends Model<ICourse> {
  findPublished(): Promise<ICourse[]>;
}

// Export the model properly
export default mongoose.models.Course as ICourseModel || mongoose.model<ICourse, ICourseModel>('Course', CourseSchema);
--------------------------------------------
// app/api/admin/courses/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { currentUser } from '@clerk/nextjs/server';
import { connectToDatabase } from '@/lib/mongodb';
import User from '@/lib/models/User';
import Course, { IS3Asset } from '@/lib/models/Course';
import mongoose from 'mongoose';

// GET - Fetch single course for admin
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await currentUser();
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    await connectToDatabase();

    // Verify admin role
    const adminUser = await User.findOne({ clerkId: user.id });
    if (!adminUser || adminUser.role !== 'admin') {
      return NextResponse.json(
        { error: 'Forbidden' },
        { status: 403 }
      );
    }

    const { id } = await params;

    if (!id || id.length !== 24) {
      return NextResponse.json(
        { error: 'Invalid course ID' },
        { status: 400 }
      );
    }

    const course = await Course.findById(id)
      .populate('instructor', 'username firstName lastName avatar')
      .populate('students.user', 'username firstName lastName avatar');

    if (!course) {
      return NextResponse.json(
        { error: 'Course not found' },
        { status: 404 }
      );
    }

    return NextResponse.json(course);
  } catch (error: any) {
    console.error('Error fetching course:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

// DELETE - Delete course
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await currentUser();
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    await connectToDatabase();

    // Verify admin role
    const adminUser = await User.findOne({ clerkId: user.id });
    if (!adminUser || adminUser.role !== 'admin') {
      return NextResponse.json(
        { error: 'Forbidden' },
        { status: 403 }
      );
    }

    const { id } = await params;

    if (!id || id.length !== 24) {
      return NextResponse.json(
        { error: 'Invalid course ID' },
        { status: 400 }
      );
    }

    const course = await Course.findByIdAndDelete(id);

    if (!course) {
      return NextResponse.json(
        { error: 'Course not found' },
        { status: 404 }
      );
    }

    return NextResponse.json(
      { message: 'Course deleted successfully' }
    );
  } catch (error: any) {
    console.error('Error deleting course:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

// PATCH - Update course
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const user = await currentUser();
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    await connectToDatabase();

    const adminUser = await User.findOne({ clerkId: user.id });
    if (!adminUser || adminUser.role !== 'admin') {
      return NextResponse.json(
        { error: 'Forbidden' },
        { status: 403 }
      );
    }

    const { id } = await params;

    if (!id || id.length !== 24) {
      return NextResponse.json(
        { error: 'Invalid course ID' },
        { status: 400 }
      );
    }

    const body = await request.json();

    // Input validation
    if (body.price !== undefined && (typeof body.price !== 'number' || body.price < 0)) {
      return NextResponse.json(
        { error: 'Invalid price value' },
        { status: 400 }
      );
    }

    if (body.level && !['beginner', 'intermediate', 'advanced'].includes(body.level)) {
      return NextResponse.json(
        { error: 'Invalid level value' },
        { status: 400 }
      );
    }

    // Find existing course
    const existingCourse = await Course.findById(id);
    if (!existingCourse) {
      return NextResponse.json(
        { error: 'Course not found' },
        { status: 404 }
      );
    }

    // Generate new slug if title changed
    let slug = existingCourse.slug;
    if (body.title && body.title !== existingCourse.title) {
      slug = body.title
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .substring(0, 100);
    }

    // Transform modules data with validation
    const transformedModules = body.modules?.map((module: any, index: number) => ({
      _id: module._id && mongoose.Types.ObjectId.isValid(module._id) ? module._id : undefined,
      title: module.title?.substring(0, 200) || '',
      description: module.description?.substring(0, 1000) || '',
      order: typeof module.order === 'number' ? module.order : index,
      lessons: module.lessons?.map((lesson: any, lessonIndex: number) => ({
        _id: lesson._id && mongoose.Types.ObjectId.isValid(lesson._id) ? lesson._id : undefined,
        title: lesson.title?.substring(0, 200) || '',
        description: lesson.description?.substring(0, 1000) || '',
        content: lesson.content || '',
        video: lesson.video as IS3Asset,
        duration: Math.max(0, Math.min(lesson.duration || 0, 10000)),
        isPreview: !!lesson.isPreview,
        resources: Array.isArray(lesson.resources) ? lesson.resources.slice(0, 10) : [],
        order: typeof lesson.order === 'number' ? lesson.order : lessonIndex
      })) || []
    })) || [];

    // Update course
    const updateData: any = {
      ...(body.title && { title: body.title.substring(0, 100) }),
      ...(body.description && { description: body.description }),
      ...(body.shortDescription && { shortDescription: body.shortDescription.substring(0, 200) }),
      ...(body.price !== undefined && { price: body.price }),
      ...(body.isFree !== undefined && { isFree: !!body.isFree }),
      ...(body.level && { level: body.level }),
      ...(body.category && { category: body.category.substring(0, 50) }),
      ...(body.tags && { tags: body.tags.slice(0, 10).map((tag: string) => tag.substring(0, 30)) }),
      ...(body.thumbnail && { thumbnail: body.thumbnail as IS3Asset }),
      ...(body.previewVideo && { previewVideo: body.previewVideo as IS3Asset }),
      ...(body.modules && { modules: transformedModules }),
      ...(body.requirements && { requirements: body.requirements.slice(0, 10).map((req: string) => req.substring(0, 200)) }),
      ...(body.learningOutcomes && { learningOutcomes: body.learningOutcomes.slice(0, 10).map((lo: string) => lo.substring(0, 200)) }),
      ...(body.isFeatured !== undefined && { isFeatured: !!body.isFeatured }),
      ...(body.isPublished !== undefined && { isPublished: !!body.isPublished }),
      ...(slug && { slug })
    };

    const updatedCourse = await Course.findByIdAndUpdate(
      id,
      updateData,
      { new: true, runValidators: true }
    ).populate('instructor', 'username firstName lastName avatar');

    if (!updatedCourse) {
      return NextResponse.json(
        { error: 'Course not found' },
        { status: 404 }
      );
    }

    return NextResponse.json(updatedCourse);
  } catch (error: any) {
    console.error('Error updating course:', error);

    if (error.code === 11000) {
      return NextResponse.json(
        { error: 'Course with this title already exists' },
        { status: 400 }
      );
    }

    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
-----------------------------------------------
// app/api/admin/courses/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { currentUser } from '@clerk/nextjs/server';
import { connectToDatabase } from '@/lib/mongodb';
import User from '@/lib/models/User';
import Course, { IS3Asset } from '@/lib/models/Course';

// app/api/admin/courses/route.ts (POST method - preserve S3 pattern)
export async function POST(request: NextRequest) {
  try {
    const user = await currentUser();
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    await connectToDatabase();

    const adminUser = await User.findOne({ clerkId: user.id });
    if (!adminUser || adminUser.role !== 'admin') {
      return NextResponse.json(
        { error: 'Forbidden' },
        { status: 403 }
      );
    }

    const body = await request.json();

    // Enhanced validation (preserve original pattern with improvements)
    const requiredFields = ['title', 'description', 'shortDescription', 'level', 'category', 'thumbnail'];
    const missingFields = requiredFields.filter(field => !body[field]);

    if (missingFields.length > 0) {
      return NextResponse.json(
        { error: `Missing required fields: ${missingFields.join(', ')}` },
        { status: 400 }
      );
    }

    // Preserve original field length patterns
    if (body.title.length > 100) {
      return NextResponse.json(
        { error: 'Title must be less than 100 characters' },
        { status: 400 }
      );
    }

    if (body.shortDescription.length > 200) {
      return NextResponse.json(
        { error: 'Short description must be less than 200 characters' },
        { status: 400 }
      );
    }

    if (!['beginner', 'intermediate', 'advanced'].includes(body.level)) {
      return NextResponse.json(
        { error: 'Invalid level value' },
        { status: 400 }
      );
    }

    // Validate price (preserve original pattern)
    if (body.price !== undefined && (typeof body.price !== 'number' || body.price < 0)) {
      return NextResponse.json(
        { error: 'Invalid price value' },
        { status: 400 }
      );
    }

    // Generate slug (preserve original pattern)
    const slug = body.title
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .trim()
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .substring(0, 100);

    // Check for existing course (preserve original pattern)
    const existingCourse = await Course.findOne({
      $or: [
        { title: body.title },
        { slug }
      ]
    });

    if (existingCourse) {
      return NextResponse.json(
        { error: 'Course with this title already exists' },
        { status: 400 }
      );
    }

    // Transform modules data with validation (preserve original pattern)
    const transformedModules = body.modules?.map((module: any, index: number) => ({
      title: module.title?.substring(0, 200) || '',
      description: module.description?.substring(0, 1000) || '',
      order: typeof module.order === 'number' ? module.order : index,
      lessons: module.lessons?.map((lesson: any, lessonIndex: number) => ({
        title: lesson.title?.substring(0, 200) || '',
        description: lesson.description?.substring(0, 1000) || '',
        content: lesson.content || '',
        video: lesson.video as IS3Asset, // Preserve S3 asset pattern
        duration: Math.max(0, Math.min(lesson.duration || 0, 10000)),
        isPreview: !!lesson.isPreview,
        resources: Array.isArray(lesson.resources) ? lesson.resources.slice(0, 10) : [],
        order: typeof lesson.order === 'number' ? lesson.order : lessonIndex
      })) || []
    })) || [];

    // Create course with proper schema structure (preserve original pattern)
    const courseData = {
      title: body.title.substring(0, 100),
      slug,
      description: body.description,
      shortDescription: body.shortDescription.substring(0, 200),
      price: body.isFree ? 0 : (body.price || 0),
      isFree: !!body.isFree,
      level: body.level,
      category: body.category.substring(0, 50),
      tags: (body.tags || []).slice(0, 10).map((tag: string) => tag.substring(0, 30)),
      thumbnail: body.thumbnail as IS3Asset, // Preserve S3 asset pattern
      previewVideo: body.previewVideo as IS3Asset | undefined, // Preserve S3 asset pattern
      modules: transformedModules,
      instructor: adminUser._id,
      requirements: (body.requirements || []).slice(0, 10).map((req: string) => req.substring(0, 200)),
      learningOutcomes: (body.learningOutcomes || []).slice(0, 10).map((lo: string) => lo.substring(0, 200)),
      isPublished: false,
      isFeatured: !!body.isFeatured,
    };

    const course = await Course.create(courseData);
    await course.populate('instructor', 'username firstName lastName avatar');

    return NextResponse.json({
      _id: course._id,
      title: course.title,
      slug: course.slug,
      description: course.description,
      shortDescription: course.shortDescription,
      instructor: course.instructor,
      price: course.price,
      isFree: course.isFree,
      level: course.level,
      category: course.category,
      tags: course.tags,
      thumbnail: course.thumbnail,
      previewVideo: course.previewVideo,
      modules: course.modules,
      requirements: course.requirements,
      learningOutcomes: course.learningOutcomes,
      isPublished: course.isPublished,
      isFeatured: course.isFeatured,
      totalStudents: course.totalStudents,
      averageRating: course.averageRating,
      totalDuration: course.totalDuration,
      totalLessons: course.totalLessons,
      createdAt: course.createdAt,
      updatedAt: course.updatedAt
    });
  } catch (error: any) {
    console.error('Error creating course:', error);

    if (error.code === 11000) {
      return NextResponse.json(
        { error: 'Course with this title already exists' },
        { status: 400 }
      );
    }

    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const user = await currentUser();
    if (!user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    await connectToDatabase();

    const adminUser = await User.findOne({ clerkId: user.id });
    if (!adminUser || adminUser.role !== 'admin') {
      return NextResponse.json(
        { error: 'Forbidden' },
        { status: 403 }
      );
    }

    const { searchParams } = new URL(request.url);
    const page = Math.max(1, parseInt(searchParams.get('page') || '1'));
    const limit = Math.max(1, Math.min(100, parseInt(searchParams.get('limit') || '10')));
    const search = searchParams.get('search') || '';
    const status = searchParams.get('status') || 'all';

    const skip = (page - 1) * limit;

    let query: any = {};

    if (search) {
      query.$or = [
        { title: { $regex: search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), $options: 'i' } },
        { description: { $regex: search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), $options: 'i' } },
        { category: { $regex: search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), $options: 'i' } }
      ];
    }

    if (status !== 'all') {
      if (status === 'published') query.isPublished = true;
      else if (status === 'draft') query.isPublished = false;
      else if (status === 'featured') query.isFeatured = true;
    }

    const [courses, total] = await Promise.all([
      Course.find(query)
        .populate('instructor', 'username firstName lastName avatar')
        .sort({ createdAt: -1 })
        .skip(skip)
        .limit(limit)
        .lean(),
      Course.countDocuments(query)
    ]);

    return NextResponse.json({
      courses: courses.map(course => ({
        ...course,
        totalReviews: course.ratings?.length || 0
      })),
      pagination: {
        currentPage: page,
        totalPages: Math.ceil(total / limit),
        total,
        hasNext: page < Math.ceil(total / limit),
        hasPrev: page > 1
      }
    });
  } catch (error: any) {
    console.error('Error fetching courses:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
---------------------------------------------
import { NextRequest, NextResponse } from 'next/server'
import { connectToDatabase } from '@/lib/mongodb'
import Course from '@/lib/models/Course'
import mongoose from 'mongoose'

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    await connectToDatabase()

    // Await the params Promise
    const { id } = await params

    if (!id) {
      return NextResponse.json({ error: 'Course ID is required' }, { status: 400 })
    }

    // Check if the ID is a valid MongoDB ObjectId
    const isValidObjectId = mongoose.Types.ObjectId.isValid(id)
    
    let course
    
    if (isValidObjectId) {
      course = await Course.findOne({
        $or: [
          { _id: new mongoose.Types.ObjectId(id) },
          { slug: id }
        ],
        isPublished: true
      })
      .populate('instructor', 'username firstName lastName avatar bio rating totalStudents')
      .populate('ratings.user', 'username firstName lastName avatar')
      .lean()
    } else {
      course = await Course.findOne({
        slug: id,
        isPublished: true
      })
      .populate('instructor', 'username firstName lastName avatar bio rating totalStudents')
      .populate('ratings.user', 'username firstName lastName avatar')
      .lean()
    }

    if (!course) {
      return NextResponse.json({ error: 'Course not found' }, { status: 404 })
    }

    // Get similar courses
    const similarCourses = await Course.find({
      _id: { $ne: course._id },
      category: course.category,
      isPublished: true
    })
      .populate('instructor', 'username firstName lastName avatar')
      .limit(4)
      .lean()

    // Calculate total reviews
    const totalReviews = course.ratings?.length || 0

    // Calculate total duration and lessons
    let totalDuration = 0
    let totalLessons = 0
    
    if (course.modules) {
      course.modules.forEach((module: any) => {
        if (module.lessons) {
          totalLessons += module.lessons.length
          module.lessons.forEach((lesson: any) => {
            totalDuration += lesson.duration || 0
          })
        }
      })
    }

    const enhancedCourse = {
      ...course,
      totalDuration,
      totalLessons,
      totalReviews,
      aiFeatures: {
        hasAIAssistant: Math.random() > 0.7,
        hasPersonalizedLearning: Math.random() > 0.5,
        hasSmartRecommendations: Math.random() > 0.6,
        hasProgressTracking: true,
        hasPersonalizedFeedback: Math.random() > 0.8
      },
      completionRate: course.totalStudents > 0 
        ? Math.floor(Math.random() * 30) + 70
        : undefined,
      similarCourses: similarCourses.map((c: any) => ({
        ...c,
        totalReviews: c.ratings?.length || 0
      }))
    }

    return NextResponse.json(enhancedCourse)
  } catch (error: any) {
    console.error('Error fetching course:', error)
    return NextResponse.json(
      { error: 'Internal server error', message: error.message },
      { status: 500 }
    )
  }
}
------------------------------------------
'use client'

import { useState, useEffect } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { useToast } from "@/components/ui/use-toast"
import { Textarea } from '@/components/ui/textarea'
import { PaymentModal } from '@/components/payment/PaymentModal'
import { 
  Star, 
  Clock, 
  PlayCircle, 
  BookOpen, 
  ChevronDown,
  Heart,
  Share2,
  Download,
  Award,
  CheckCircle,
  Loader2,
  MessageCircle,
  ArrowLeft,
  ArrowRight,
  Video,
  Play,
  Users,
  Check,
  Calendar,
  FileText,
  Menu,
  X,
  Bookmark,
  GraduationCap,
  Target,
  Zap,
  Shield,
  TrendingUp,
  BookCheck,
  Eye,
  Clock4,
  ChevronRight,
  ExternalLink,
  Globe,
  UserCheck,
  Medal,
  Crown,
  Rocket,
  Sparkles
} from 'lucide-react'

interface S3Asset {
  key: string
  url: string
  size: number
  type: 'image' | 'video'
  duration?: number
  width?: number
  height?: number
}

interface Lesson {
  _id: string
  title: string
  description: string
  duration: number
  isPreview: boolean
  order: number
  video?: S3Asset
  resources: Array<{
    title: string
    url: string
    type: string
  }>
}

interface Module {
  _id: string
  title: string
  description: string
  order: number
  lessons: Lesson[]
}

interface Course {
  _id: string
  title: string
  description: string
  shortDescription: string
  slug: string
  instructor: {
    _id: string
    firstName: string
    lastName: string
    username: string
    avatar?: string
    bio?: string
    rating?: number
    totalStudents?: number
    expertise?: string[]
  }
  price: number
  isFree: boolean
  level: 'beginner' | 'intermediate' | 'advanced'
  category: string
  tags: string[]
  thumbnail: S3Asset
  previewVideo?: S3Asset
  totalStudents: number
  averageRating: number
  totalReviews: number
  modules: Module[]
  totalDuration: number
  totalLessons: number
  isPublished: boolean
  isFeatured: boolean
  requirements: string[]
  learningOutcomes: string[]
  ratings: Array<{
    _id: string
    user: {
      _id: string
      firstName: string
      lastName: string
      username: string
      avatar?: string
    }
    rating: number
    review?: string
    createdAt: string
  }>
  createdAt: string
  updatedAt: string
  completionRate?: number
  similarCourses?: Course[]
}

interface UserProgress {
  _id: string
  courseId: string
  userId: string
  enrolled: boolean
  progress: number
  completed: boolean
  completedLessons: string[]
  currentLesson: string | null
  timeSpent: number
  lastAccessed: Date
  completedAt?: Date
}

export default function CourseDetailPage() {
  const params = useParams()
  const router = useRouter()
  const { toast } = useToast()
  const [course, setCourse] = useState<Course | null>(null)
  const [userProgress, setUserProgress] = useState<UserProgress | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [isEnrolling, setIsEnrolling] = useState<string | null>(null)
  const [activeTab, setActiveTab] = useState<'overview' | 'curriculum' | 'reviews' | 'instructor'>('overview')
  const [expandedModules, setExpandedModules] = useState<Set<number>>(new Set([0]))
  const [newRating, setNewRating] = useState({ rating: 5, review: '' })
  const [isSubmittingRating, setIsSubmittingRating] = useState(false)
  const [isLearningMode, setIsLearningMode] = useState(false)
  const [updatingProgress, setUpdatingProgress] = useState<string | null>(null)
  const [activeLesson, setActiveLesson] = useState<Lesson | null>(null)
  const [completedLessons, setCompletedLessons] = useState<Set<string>>(new Set())
  const [showPaymentModal, setShowPaymentModal] = useState(false)
  const [showEnrollmentSuccess, setShowEnrollmentSuccess] = useState(false)
  const [showMobileCurriculum, setShowMobileCurriculum] = useState(false)
  const [isBookmarked, setIsBookmarked] = useState(false)

  const slug = params.slug as string

  const fetchCourseData = async () => {
    try {
      setLoading(true)
      setError(null)

      const [courseResponse, progressResponse] = await Promise.all([
        fetch(`/api/courses/${slug}`),
        fetch(`/api/courses/${slug}/progress`)
      ])

      if (!courseResponse.ok) {
        throw new Error(`Failed to load course`)
      }

      const data = await courseResponse.json()
      
      const processedCourse: Course = {
        ...data,
        thumbnail: data.thumbnail ? {
          key: data.thumbnail.key || data.thumbnail.public_id,
          url: data.thumbnail.url || data.thumbnail.secure_url,
          size: data.thumbnail.size || data.thumbnail.bytes,
          type: data.thumbnail.type || 'image',
          width: data.thumbnail.width,
          height: data.thumbnail.height
        } : {
          key: 'default',
          url: '/placeholder-course.jpg',
          size: 0,
          type: 'image'
        },
        previewVideo: data.previewVideo ? {
          key: data.previewVideo.key || data.previewVideo.public_id,
          url: data.previewVideo.url || data.previewVideo.secure_url,
          size: data.previewVideo.size || data.previewVideo.bytes,
          type: data.previewVideo.type || 'video',
          duration: data.previewVideo.duration
        } : undefined,
        modules: data.modules?.map((module: any) => ({
          ...module,
          lessons: module.lessons?.map((lesson: any) => ({
            ...lesson,
            video: lesson.video ? {
              key: lesson.video.key || lesson.video.public_id,
              url: lesson.video.url || lesson.video.secure_url,
              size: lesson.video.size || lesson.video.bytes,
              type: lesson.video.type || 'video',
              duration: lesson.video.duration
            } : undefined
          })) || []
        })) || []
      }

      setCourse(processedCourse)

      if (progressResponse.ok) {
        const progressData = await progressResponse.json()
        
        const userProgressData: UserProgress = {
          _id: progressData._id || `temp-${processedCourse._id}`,
          courseId: progressData.courseId || processedCourse._id,
          userId: progressData.userId || 'current-user',
          enrolled: true,
          progress: progressData.progress || 0,
          completed: progressData.completed || false,
          completedLessons: progressData.completedLessons || [],
          currentLesson: progressData.currentLesson || null,
          timeSpent: progressData.timeSpent || 0,
          lastAccessed: progressData.lastAccessed ? new Date(progressData.lastAccessed) : new Date()
        }
        
        setUserProgress(userProgressData)
        setCompletedLessons(new Set(userProgressData.completedLessons))
        
        if (userProgressData.currentLesson) {
          const lesson = findLessonById(processedCourse, userProgressData.currentLesson)
          if (lesson) {
            setActiveLesson(lesson)
          }
        } else if (processedCourse.modules[0]?.lessons[0]) {
          setActiveLesson(processedCourse.modules[0].lessons[0])
        }
      } else {
        setUserProgress(null)
        setCompletedLessons(new Set())
        
        if (processedCourse.modules[0]?.lessons[0]) {
          setActiveLesson(processedCourse.modules[0].lessons[0])
        }
      }
      
    } catch (err: any) {
      console.error('Error fetching course:', err)
      setError(err.message || 'Failed to load course')
      toast({
        title: 'Error',
        description: 'Failed to load course details',
        variant: 'destructive',
      })
    } finally {
      setLoading(false)
    }
  }

  const findLessonById = (courseData: Course, lessonId: string): Lesson | null => {
    for (const module of courseData.modules) {
      for (const lesson of module.lessons) {
        if (lesson._id === lessonId) {
          return lesson
        }
      }
    }
    return null
  }

  useEffect(() => {
    if (slug) {
      fetchCourseData()
    }
  }, [slug])

  const enrollInCourse = async () => {
    if (!course || isEnrolling) return
    
    setIsEnrolling(course._id)
    setError(null)
    
    try {
      const response = await fetch(`/api/courses/${course._id}/enroll`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })

      const result = await response.json()

      if (response.status === 402 && result.requiresPayment) {
        setShowPaymentModal(true)
        setIsEnrolling(null)
        return
      }

      if (response.ok) {
        if (result.enrolled || result.alreadyEnrolled) {
          const newProgress: UserProgress = {
            _id: result.progress?._id || `temp-${course._id}`,
            courseId: course._id,
            userId: 'current-user',
            enrolled: true,
            progress: result.progress?.progress || 0,
            completed: result.progress?.completed || false,
            completedLessons: result.progress?.completedLessons || [],
            currentLesson: result.progress?.currentLesson || course.modules[0]?.lessons[0]?._id || null,
            timeSpent: result.progress?.timeSpent || 0,
            lastAccessed: new Date()
          }
          
          setUserProgress(newProgress)
          setCompletedLessons(new Set(newProgress.completedLessons))
          
          toast({
            title: 'üéâ Welcome to the Course!',
            description: 'Your learning journey begins now. Enjoy!',
            variant: 'default',
          })

          setShowEnrollmentSuccess(true)
          setTimeout(() => setShowEnrollmentSuccess(false), 3000)
        } else {
          throw new Error('Unexpected response from server')
        }
      } else {
        throw new Error(result.error || 'Failed to enroll')
      }

    } catch (err: any) {
      console.error('Error enrolling:', err)
      
      toast({
        title: 'Enrollment Failed',
        description: 'Please try again or contact support',
        variant: 'destructive',
      })
    } finally {
      setIsEnrolling(null)
    }
  }

  const handlePaymentSuccess = (courseId: string) => {
    setShowPaymentModal(false)
    setShowEnrollmentSuccess(true)
    
    setUserProgress({
      _id: `temp-${courseId}`,
      courseId,
      userId: 'current-user',
      enrolled: true,
      progress: 0,
      completed: false,
      completedLessons: [],
      currentLesson: course?.modules[0]?.lessons[0]?._id || null,
      timeSpent: 0,
      lastAccessed: new Date()
    })
    
    fetchCourseData()
    
    toast({
      title: 'üéâ Payment Successful!',
      description: 'Welcome aboard! Let\'s start learning.',
      variant: 'default',
    })
  }

  const updateProgress = async (lessonId: string, completed: boolean = false, isCurrent: boolean = true) => {
    if (!course || !userProgress?.enrolled) return

    setUpdatingProgress(lessonId)
    
    try {
      const response = await fetch(`/api/courses/${course._id}/progress`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          lessonId,
          completed,
          current: isCurrent
        })
      })

      if (response.ok) {
        const updatedProgress = await response.json()
        setUserProgress(updatedProgress)
        setCompletedLessons(new Set(updatedProgress.completedLessons || []))
        
        if (completed) {
          toast({
            title: '‚ú® Great Work!',
            description: 'Lesson completed successfully!',
            variant: 'default'
          })
        }
      } else {
        throw new Error('Failed to update progress')
      }
    } catch (error) {
      console.error('Error updating progress:', error)
      toast({
        title: 'Error',
        description: 'Failed to update progress',
        variant: 'destructive'
      })
    } finally {
      setUpdatingProgress(null)
    }
  }

  const handleLessonSelect = (lesson: Lesson) => {
    setActiveLesson(lesson)
    updateProgress(lesson._id, false, true)
  }

  const handleLessonComplete = (lessonId: string) => {
    updateProgress(lessonId, true, false)
  }

  const getNextLesson = (): Lesson | null => {
    if (!course || !activeLesson) return null

    let found = false
    for (const module of course.modules) {
      for (const lesson of module.lessons) {
        if (found) return lesson
        if (lesson._id === activeLesson._id) found = true
      }
    }
    return null
  }

  const getPreviousLesson = (): Lesson | null => {
    if (!course || !activeLesson) return null

    const allLessons: Lesson[] = []
    course.modules.forEach(module => {
      module.lessons.forEach(lesson => {
        allLessons.push(lesson)
      })
    })

    const currentIndex = allLessons.findIndex(lesson => lesson._id === activeLesson._id)
    
    if (currentIndex > 0) {
      return allLessons[currentIndex - 1]
    }
    return null
  }

  const navigateToLesson = (direction: 'next' | 'prev') => {
    if (!course || !activeLesson) return

    const allLessons: Lesson[] = []
    course.modules.forEach(module => {
      module.lessons.forEach(lesson => {
        allLessons.push(lesson)
      })
    })

    const currentIndex = allLessons.findIndex(lesson => lesson._id === activeLesson._id)

    let targetLesson: Lesson | null = null

    if (direction === 'next' && currentIndex < allLessons.length - 1) {
      targetLesson = allLessons[currentIndex + 1]
    } else if (direction === 'prev' && currentIndex > 0) {
      targetLesson = allLessons[currentIndex - 1]
    }

    if (targetLesson) {
      handleLessonSelect(targetLesson)
    }
  }

  useEffect(() => {
    if (!isLearningMode) return

    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') {
        navigateToLesson('next')
      } else if (e.key === 'ArrowLeft') {
        navigateToLesson('prev')
      }
    }

    window.addEventListener('keydown', handleKeyPress)
    return () => window.removeEventListener('keydown', handleKeyPress)
  }, [isLearningMode, activeLesson, course])

  const submitRating = async () => {
    if (!course || !newRating.rating || isSubmittingRating) return
    
    setIsSubmittingRating(true)
    try {
      const response = await fetch(`/api/courses/${course._id}/rate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newRating)
      })

      const result = await response.json()

      if (response.ok && result.success) {
        setCourse(result.course)
        setNewRating({ rating: 5, review: '' })
        toast({
          title: '‚≠ê Thank You!',
          description: 'Your review has been submitted.',
          variant: 'default',
        })
      } else {
        throw new Error(result.error || 'Failed to submit rating')
      }
    } catch (err: any) {
      console.error('Error submitting rating:', err)
      toast({
        title: 'Error',
        description: 'Failed to submit review',
        variant: 'destructive',
      })
    } finally {
      setIsSubmittingRating(false)
    }
  }

  const toggleModule = (moduleIndex: number) => {
    setExpandedModules(prev => {
      const newSet = new Set(prev)
      if (newSet.has(moduleIndex)) {
        newSet.delete(moduleIndex)
      } else {
        newSet.add(moduleIndex)
      }
      return newSet
    })
  }

  const formatDuration = (minutes: number) => {
    const hours = Math.floor(minutes / 60)
    const mins = minutes % 60
    if (hours > 0) {
      return `${hours}h ${mins > 0 ? `${mins}m` : ''}`.trim()
    }
    return `${mins}m`
  }

  const handlePreviewLesson = (lesson: Lesson) => {
    if (lesson.video && lesson.isPreview) {
      window.open(lesson.video.url, '_blank')
    }
  }

  const calculateModuleProgress = (module: Module) => {
    if (!userProgress) return 0
    const completedInModule = module.lessons.filter(lesson => 
      completedLessons.has(lesson._id)
    ).length
    return (completedInModule / module.lessons.length) * 100
  }

  // Stunning Enrollment Button
  const EnrollmentButton = () => {
    if (!userProgress || userProgress.enrolled === false) {
      return (
        <Button
          onClick={enrollInCourse}
          disabled={!!isEnrolling}
          className="group w-full h-12 text-sm font-semibold relative overflow-hidden bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700" />
          
          <div className="relative flex items-center justify-center gap-2">
            {isEnrolling === course?._id ? (
              <>
                <Loader2 className="w-4 h-4 animate-spin" />
                <span>Enrolling...</span>
              </>
            ) : (
              <>
                <GraduationCap className="w-4 h-4" />
                <span>{course?.isFree ? 'Try Sample Lesson' : `Enroll Now - $${course?.price}`}</span>
              </>
            )}
          </div>
        </Button>
      )
    }

    if (userProgress.completed) {
      return (
        <Button
          onClick={() => router.push(`/certificates/${course?._id}`)}
          className="w-full h-12 text-sm font-semibold bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white rounded-xl shadow-sm"
        >
          <Award className="w-4 h-4 mr-2" />
          View Certificate
        </Button>
      )
    }

    const hasProgress = userProgress.progress > 0
    
    return (
      <Button
        onClick={() => setIsLearningMode(true)}
        className="w-full h-12 text-sm font-semibold bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-xl shadow-sm"
      >
        <Play className="w-4 h-4 mr-2" />
        {hasProgress ? 'Continue' : 'Start'}
      </Button>
    )
  }

  // Compact Feature Cards for mobile
  const FeatureCard = ({ icon: Icon, title, description, color }: {
    icon: any
    title: string
    description: string
    color: 'blue' | 'green' | 'purple' | 'amber'
  }) => {
    const colors = {
      blue: 'from-blue-50 to-blue-100 border-blue-100',
      green: 'from-green-50 to-green-100 border-green-100',
      purple: 'from-purple-50 to-purple-100 border-purple-100',
      amber: 'from-amber-50 to-amber-100 border-amber-100'
    }

    const iconColors = {
      blue: 'text-blue-600',
      green: 'text-green-600',
      purple: 'text-purple-600',
      amber: 'text-amber-600'
    }

    return (
      <div className={`p-3 rounded-lg bg-gradient-to-br ${colors[color]} border`}>
        <div className="flex items-center gap-2 mb-2">
          <div className={`p-1.5 rounded-md ${color === 'blue' ? 'bg-blue-100' : color === 'green' ? 'bg-green-100' : color === 'purple' ? 'bg-purple-100' : 'bg-amber-100'}`}>
            <Icon className={`w-3.5 h-3.5 ${iconColors[color]}`} />
          </div>
          <h4 className="font-semibold text-gray-900 text-sm">{title}</h4>
        </div>
        <p className="text-xs text-gray-600 leading-tight">{description}</p>
      </div>
    )
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <div className="container mx-auto px-4 py-8">
          <div className="flex justify-center items-center min-h-[60vh]">
            <div className="text-center">
              <div className="relative">
                <div className="w-12 h-12 border-3 border-blue-200 rounded-full"></div>
                <div className="w-12 h-12 border-3 border-blue-600 border-t-transparent rounded-full animate-spin absolute top-0"></div>
              </div>
              <p className="mt-4 text-sm text-gray-600">Loading course...</p>
            </div>
          </div>
        </div>
      </div>
    )
  }

  if (error || !course) {
    return (
      <div className="min-h-screen bg-gray-50">
        <div className="container mx-auto px-4 py-8">
          <div className="text-center py-12">
            <div className="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-4">
              <BookOpen className="w-7 h-7 text-gray-400" />
            </div>
            <h2 className="text-lg font-bold text-gray-900 mb-2">
              Course Not Available
            </h2>
            <p className="text-sm text-gray-600 mb-6 max-w-xs mx-auto">
              This course is currently not available or may have been updated.
            </p>
            <div className="flex flex-col gap-2">
              <Button 
                onClick={fetchCourseData} 
                className="px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm"
              >
                Try Again
              </Button>
              <Button 
                onClick={() => router.push('/courses')}
                variant="outline"
                className="px-5 py-2.5 rounded-lg text-sm"
              >
                Browse Courses
              </Button>
            </div>
          </div>
        </div>
      </div>
    )
  }

  if (isLearningMode && activeLesson) {
    const nextLesson = getNextLesson()
    const previousLesson = getPreviousLesson()

    return (
      <div className="min-h-screen bg-gray-50">
        <div className="sticky top-0 z-50 bg-white border-b">
          <div className="px-4 py-3 flex items-center justify-between">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setIsLearningMode(false)}
              className="p-1.5"
            >
              <ArrowLeft className="w-4 h-4" />
            </Button>
            <div className="flex-1 mx-3 min-w-0">
              <h1 className="text-xs font-semibold text-gray-900 truncate">{course.title}</h1>
              <div className="flex items-center gap-1.5 mt-1">
                <div className="w-12 h-1 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-blue-600 transition-all duration-500"
                    style={{ width: `${Math.round((userProgress?.progress || 0) * 100)}%` }}
                  />
                </div>
                <span className="text-xs font-semibold text-blue-600">
                  {Math.round((userProgress?.progress || 0) * 100)}%
                </span>
              </div>
            </div>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowMobileCurriculum(!showMobileCurriculum)}
              className="p-1.5"
            >
              <Menu className="w-4 h-4" />
            </Button>
          </div>
        </div>

        <div className="container px-4 py-4">
          <div className="space-y-4">
            <div className="bg-black rounded-lg overflow-hidden">
              {activeLesson.video ? (
                <video
                  src={activeLesson.video.url}
                  controls
                  className="w-full aspect-video"
                  playsInline
                />
              ) : (
                <div className="aspect-video flex items-center justify-center bg-gray-900">
                  <div className="text-center">
                    <div className="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center mx-auto mb-3">
                      <PlayCircle className="w-6 h-6 text-white/60" />
                    </div>
                    <p className="text-white/80 text-sm">Video loading...</p>
                  </div>
                </div>
              )}
            </div>

            <div className="bg-white rounded-lg border p-4">
              <div className="mb-4">
                <div className="flex items-center gap-1.5 mb-3">
                  <Badge className="bg-blue-100 text-blue-700 border-0 text-xs px-2 py-0.5">
                    Lesson {course.modules.flatMap(m => m.lessons).findIndex(l => l._id === activeLesson._id) + 1}
                  </Badge>
                  {activeLesson.isPreview && (
                    <Badge className="bg-amber-100 text-amber-700 border-0 text-xs px-2 py-0.5">
                      <Eye className="w-2.5 h-2.5 mr-1" />
                      Preview
                    </Badge>
                  )}
                </div>
                
                <h1 className="text-lg font-bold text-gray-900 mb-2">
                  {activeLesson.title}
                </h1>
                
                <p className="text-sm text-gray-600">
                  {activeLesson.description}
                </p>
              </div>
              
              <div className="flex items-center justify-between pt-3 border-t">
                <div className="flex items-center gap-4 text-gray-500">
                  <div className="flex items-center gap-1.5">
                    <Clock className="w-3.5 h-3.5" />
                    <span className="text-sm">{formatDuration(activeLesson.duration)}</span>
                  </div>
                </div>
                
                <Button
                  onClick={() => handleLessonComplete(activeLesson._id)}
                  disabled={updatingProgress === activeLesson._id || completedLessons.has(activeLesson._id)}
                  className={`rounded-lg text-sm px-3 py-1.5 h-8 ${
                    completedLessons.has(activeLesson._id) 
                      ? 'bg-green-600 hover:bg-green-700' 
                      : 'bg-blue-600 hover:bg-blue-700'
                  }`}
                >
                  {updatingProgress === activeLesson._id ? (
                    <Loader2 className="w-3.5 h-3.5 animate-spin" />
                  ) : completedLessons.has(activeLesson._id) ? (
                    'Completed'
                  ) : (
                    'Mark Complete'
                  )}
                </Button>
              </div>
            </div>

            {activeLesson.resources && activeLesson.resources.length > 0 && (
              <div className="bg-white rounded-lg border p-4">
                <h3 className="text-base font-semibold text-gray-900 mb-3 flex items-center gap-1.5">
                  <FileText className="w-4 h-4 text-blue-600" />
                  Lesson Resources
                </h3>
                
                <div className="space-y-2">
                  {activeLesson.resources.map((resource, index) => (
                    <div
                      key={index}
                      className="p-3 bg-gray-50 rounded border hover:border-blue-300 transition-colors cursor-pointer"
                      onClick={() => window.open(resource.url, '_blank')}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="p-1.5 bg-blue-100 rounded">
                            <Download className="w-3 h-3 text-blue-600" />
                          </div>
                          <div>
                            <p className="font-medium text-gray-900 text-sm">
                              {resource.title}
                            </p>
                            <p className="text-xs text-gray-500">
                              {resource.type.toUpperCase()}
                            </p>
                          </div>
                        </div>
                        <ExternalLink className="w-3 h-3 text-gray-400" />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => navigateToLesson('prev')}
                disabled={!previousLesson}
                className="flex-1 rounded-lg text-sm py-2"
              >
                <ArrowLeft className="w-3.5 h-3.5 mr-1.5" />
                Previous
              </Button>

              <Button
                onClick={() => navigateToLesson('next')}
                disabled={!nextLesson}
                className="flex-1 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm py-2"
              >
                Next
                <ArrowRight className="w-3.5 h-3.5 ml-1.5" />
              </Button>
            </div>
          </div>
        </div>

        {showMobileCurriculum && (
          <div className="fixed inset-0 z-50 bg-white animate-in slide-in-from-right">
            <div className="sticky top-0 bg-white border-b p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <BookOpen className="w-4 h-4 text-blue-600" />
                  <h2 className="text-base font-semibold text-gray-900">Course Content</h2>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => setShowMobileCurriculum(false)}
                  className="p-1.5"
                >
                  <X className="w-4 h-4" />
                </Button>
              </div>
            </div>
            <div className="h-[calc(100vh-64px)] overflow-y-auto p-4">
              {course.modules.map((module, moduleIndex) => (
                <div key={module._id} className="mb-3">
                  <div 
                    className="p-3 bg-gray-50 rounded border cursor-pointer hover:border-blue-300 transition-colors"
                    onClick={() => toggleModule(moduleIndex)}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <div className="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                          <span className="font-semibold text-blue-700 text-xs">{moduleIndex + 1}</span>
                        </div>
                        <div>
                          <h3 className="font-medium text-gray-900 text-sm">{module.title}</h3>
                          <p className="text-xs text-gray-500 mt-0.5">
                            {module.lessons.length} lessons
                          </p>
                        </div>
                      </div>
                      <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${expandedModules.has(moduleIndex) ? 'rotate-180' : ''}`} />
                    </div>
                  </div>
                  
                  {expandedModules.has(moduleIndex) && (
                    <div className="mt-1.5 space-y-1.5 animate-in fade-in">
                      {module.lessons.map((lesson, lessonIndex) => {
                        const isCompleted = completedLessons.has(lesson._id)
                        const isActive = activeLesson?._id === lesson._id
                        
                        return (
                          <div
                            key={lesson._id}
                            className={`p-3 rounded border cursor-pointer transition-colors ${
                              isActive 
                                ? 'bg-blue-600 text-white border-blue-600' 
                                : isCompleted
                                ? 'bg-green-50 border-green-200'
                                : 'bg-white border-gray-200 hover:border-blue-300'
                            }`}
                            onClick={() => {
                              handleLessonSelect(lesson)
                              setShowMobileCurriculum(false)
                            }}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <div className={`w-5 h-5 rounded flex items-center justify-center ${
                                  isActive ? 'bg-white/20' : isCompleted ? 'bg-green-100' : 'bg-gray-100'
                                }`}>
                                  {isCompleted ? (
                                    <Check className={`w-2.5 h-2.5 ${isActive ? 'text-white' : 'text-green-600'}`} />
                                  ) : (
                                    <PlayCircle className={`w-2.5 h-2.5 ${isActive ? 'text-white' : 'text-gray-500'}`} />
                                  )}
                                </div>
                                <div className="flex-1">
                                  <p className={`font-medium text-sm ${isActive ? 'text-white' : 'text-gray-900'}`}>
                                    {lessonIndex + 1}. {lesson.title}
                                  </p>
                                  <div className="flex items-center gap-1.5 mt-0.5">
                                    <Clock className={`w-2.5 h-2.5 ${isActive ? 'text-white/80' : 'text-gray-400'}`} />
                                    <span className={`text-xs ${isActive ? 'text-white/80' : 'text-gray-500'}`}>
                                      {formatDuration(lesson.duration)}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Mobile Header */}
      <div className="sticky top-0 z-50 bg-white border-b">
        <div className="px-4 py-3 flex items-center justify-between">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => router.back()}
            className="p-1.5"
          >
            <ArrowLeft className="w-4 h-4" />
          </Button>
          <h1 className="text-sm font-semibold text-gray-900 truncate max-w-[140px]">
            {course.title}
          </h1>
          <div className="flex items-center gap-0">
            <Button 
              variant="ghost" 
              size="sm" 
              className="p-1.5"
              onClick={() => setIsBookmarked(!isBookmarked)}
            >
              <Heart className={`w-4 h-4 ${isBookmarked ? 'fill-red-500 text-red-500' : 'text-gray-500'}`} />
            </Button>
          </div>
        </div>
      </div>

      {/* Preview Video Section - Moved to TOP */}
      {course.previewVideo && (
        <div className="bg-white border-b">
          <div className="px-4 py-4">
            <h2 className="text-base font-semibold text-gray-900 mb-3">Course Preview</h2>
            <div className="rounded-lg overflow-hidden bg-black">
              <video
                src={course.previewVideo.url}
                className="w-full aspect-video"
                controls
                playsInline
              />
            </div>
          </div>
        </div>
      )}

      {/* Course Header */}
      <div className="bg-white px-4 py-6 border-b">
        <div className="space-y-4">
          <div className="flex flex-wrap gap-1.5">
            <Badge className="bg-blue-100 text-blue-700 border-0 text-xs px-2 py-0.5">
              {course.category}
            </Badge>
            <Badge className="bg-gray-100 text-gray-700 border-0 text-xs px-2 py-0.5">
              {course.level.charAt(0).toUpperCase() + course.level.slice(1)} Level
            </Badge>
          </div>

          <h1 className="text-2xl font-bold text-gray-900 leading-tight">
            {course.title}
          </h1>
          
          <p className="text-gray-600 text-sm leading-relaxed">
            {course.shortDescription}
          </p>

          <div className="flex items-center justify-between py-3">
            <div className="flex items-center gap-3">
              <div className="relative">
                <div className="w-10 h-10 rounded-lg overflow-hidden bg-gradient-to-br from-blue-100 to-purple-100">
                  <img
                    src={course.instructor.avatar || '/placeholder-avatar.jpg'}
                    alt={course.instructor.username}
                    className="w-full h-full object-cover"
                  />
                </div>
              </div>
              <div>
                <p className="font-semibold text-gray-900 text-sm">
                  {course.instructor.firstName} {course.instructor.lastName}
                </p>
                <div className="flex items-center gap-1.5 mt-0.5">
                  <Star className="w-3 h-3 fill-amber-400 text-amber-400" />
                  <span className="text-xs font-medium text-gray-900">{course.instructor.rating?.toFixed(1) || '4.8'}</span>
                  <span className="text-xs text-gray-500">‚Ä¢ Instructor</span>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-3 py-3 border-y">
            <div className="text-center">
              <div className="flex items-center justify-center gap-1.5 mb-1">
                <Star className="w-4 h-4 fill-amber-400 text-amber-400" />
                <span className="font-bold text-gray-900">{course.averageRating.toFixed(1)}</span>
              </div>
              <p className="text-xs text-gray-500">Rating</p>
            </div>
            
            <div className="text-center">
              <div className="flex items-center justify-center gap-1.5 mb-1">
                <BookOpen className="w-4 h-4 text-blue-600" />
                <span className="font-bold text-gray-900">{course.totalLessons}</span>
              </div>
              <p className="text-xs text-gray-500">Lessons</p>
            </div>
            
            <div className="text-center">
              <div className="flex items-center justify-center gap-1.5 mb-1">
                <Users className="w-4 h-4 text-emerald-600" />
                <span className="font-bold text-gray-900">{course.totalStudents}</span>
              </div>
              <p className="text-xs text-gray-500">Students</p>
            </div>
          </div>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="sticky top-[60px] z-40 bg-white border-b">
        <div className="flex overflow-x-auto px-4 -mb-px">
          {[
            { id: 'overview', label: 'Overview', icon: BookOpen },
            { id: 'curriculum', label: 'Curriculum', icon: GraduationCap },
            { id: 'reviews', label: 'Reviews', icon: Star },
            { id: 'instructor', label: 'Instructor', icon: UserCheck }
          ].map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center gap-1.5 px-4 py-3 font-medium border-b-2 whitespace-nowrap text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-600 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <Icon className="w-3.5 h-3.5" />
                {tab.label}
              </button>
            )
          })}
        </div>
      </div>

      {/* Main Content */}
      <div className="px-4 py-6">
        <div className="space-y-6">
          {activeTab === 'overview' && (
            <>
              <div className="space-y-4">
                <div>
                  <h3 className="text-lg font-bold text-gray-900 mb-3">About This Course</h3>
                  <p className="text-gray-700 text-sm leading-relaxed whitespace-pre-line">
                    {course.description}
                  </p>
                </div>

                <div>
                  <h3 className="text-lg font-bold text-gray-900 mb-3">What You'll Learn</h3>
                  <div className="space-y-2">
                    {course.learningOutcomes.map((outcome, index) => (
                      <div key={index} className="flex items-start gap-2 p-2.5 bg-gray-50 rounded-lg">
                        <Check className="w-3.5 h-3.5 text-green-600 flex-shrink-0 mt-0.5" />
                        <span className="font-medium text-gray-900 text-sm">{outcome}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="text-lg font-bold text-gray-900 mb-3">Requirements</h3>
                  <div className="space-y-2">
                    {course.requirements.map((requirement, index) => (
                      <div key={index} className="flex items-center gap-2 p-2.5 bg-gray-50 rounded-lg">
                        <div className="w-5 h-5 bg-blue-100 rounded flex items-center justify-center">
                          <span className="font-medium text-blue-700 text-xs">{index + 1}</span>
                        </div>
                        <span className="font-medium text-gray-900 text-sm">{requirement}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </>
          )}

          {activeTab === 'curriculum' && (
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-bold text-gray-900">Course Curriculum</h3>
                  <p className="text-gray-600 text-sm mt-0.5">
                    {course.totalLessons} lessons
                  </p>
                </div>
                {userProgress?.enrolled && (
                  <div className="text-right">
                    <p className="text-xs text-gray-500">Progress</p>
                    <p className="text-base font-bold text-blue-600">
                      {Math.round(userProgress.progress * 100)}%
                    </p>
                  </div>
                )}
              </div>

              <div className="space-y-3">
                {course.modules.map((module, moduleIndex) => {
                  const moduleProgress = calculateModuleProgress(module)
                  
                  return (
                    <div key={module._id} className="bg-white rounded-lg border overflow-hidden">
                      <div 
                        className="p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                        onClick={() => toggleModule(moduleIndex)}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-100 rounded flex items-center justify-center">
                              <span className="font-bold text-blue-700 text-sm">{moduleIndex + 1}</span>
                            </div>
                            <div className="flex-1">
                              <h4 className="font-bold text-gray-900 text-sm">{module.title}</h4>
                              <div className="flex items-center gap-2 text-xs text-gray-500 mt-0.5">
                                <span>{module.lessons.length} lessons</span>
                              </div>
                            </div>
                          </div>
                          <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${expandedModules.has(moduleIndex) ? 'rotate-180' : ''}`} />
                        </div>
                      </div>
                      
                      {expandedModules.has(moduleIndex) && (
                        <div className="px-3 pb-3 animate-in fade-in">
                          <div className="space-y-1.5">
                            {module.lessons.map((lesson, lessonIndex) => {
                              const isCompleted = completedLessons.has(lesson._id)
                              
                              return (
                                <div
                                  key={lesson._id}
                                  className="p-2.5 bg-gray-50 rounded border"
                                >
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                      <div className={`w-6 h-6 rounded flex items-center justify-center ${
                                        isCompleted ? 'bg-green-100' : 'bg-blue-100'
                                      }`}>
                                        {isCompleted ? (
                                          <Check className="w-3 h-3 text-green-600" />
                                        ) : (
                                          <PlayCircle className="w-3 h-3 text-blue-600" />
                                        )}
                                      </div>
                                      <div className="flex-1 min-w-0">
                                        <p className="font-medium text-gray-900 text-sm truncate">
                                          {lessonIndex + 1}. {lesson.title}
                                        </p>
                                        <div className="flex items-center gap-2 mt-0.5">
                                          <div className="flex items-center gap-1 text-xs text-gray-500">
                                            <Clock className="w-2.5 h-2.5" />
                                            <span>{formatDuration(lesson.duration)}</span>
                                          </div>
                                          {lesson.isPreview && (
                                            <Badge className="bg-amber-100 text-amber-700 text-xs px-1.5 py-0">
                                              Preview
                                            </Badge>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                    
                                    {userProgress?.enrolled ? (
                                      <Button 
                                        onClick={() => {
                                          setActiveLesson(lesson)
                                          setIsLearningMode(true)
                                        }}
                                        className={`rounded text-xs px-2 py-1 h-6 ${
                                          isCompleted 
                                            ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                                            : 'bg-blue-600 hover:bg-blue-700 text-white'
                                        }`}
                                      >
                                        {isCompleted ? 'Review' : 'Start'}
                                      </Button>
                                    ) : lesson.isPreview && lesson.video ? (
                                      <Button 
                                        onClick={() => handlePreviewLesson(lesson)}
                                        className="rounded bg-amber-100 text-amber-700 hover:bg-amber-200 text-xs px-2 py-1 h-6"
                                      >
                                        Preview
                                      </Button>
                                    ) : null}
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          )}

          {activeTab === 'reviews' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg border p-4">
                <div className="text-center mb-4">
                  <div className="text-3xl font-bold text-gray-900 mb-1">
                    {course.averageRating.toFixed(1)}
                  </div>
                  <div className="flex items-center justify-center mb-2">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-4 h-4 ${
                          star <= Math.floor(course.averageRating)
                            ? 'fill-amber-400 text-amber-400'
                            : 'text-gray-300'
                        }`}
                      />
                    ))}
                  </div>
                  <p className="text-gray-600 text-sm">
                    Based on {course.totalReviews} reviews
                  </p>
                </div>

                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1.5">Your Rating</label>
                    <div className="flex gap-0.5">
                      {[1, 2, 3, 4, 5].map((star) => (
                        <button
                          key={star}
                          type="button"
                          onClick={() => setNewRating(prev => ({ ...prev, rating: star }))}
                          className="p-1"
                        >
                          <Star
                            className={`w-5 h-5 ${
                              star <= newRating.rating
                                ? 'fill-amber-400 text-amber-400'
                                : 'text-gray-300'
                            }`}
                          />
                        </button>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1.5">Your Review</label>
                    <Textarea
                      value={newRating.review}
                      onChange={(e) => setNewRating(prev => ({ ...prev, review: e.target.value }))}
                      placeholder="Share your experience..."
                      className="min-h-[80px] rounded-lg text-sm"
                    />
                  </div>
                  <Button
                    onClick={submitRating}
                    disabled={isSubmittingRating || !newRating.rating}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm py-2"
                  >
                    {isSubmittingRating ? (
                      <>
                        <Loader2 className="w-3.5 h-3.5 animate-spin mr-1.5" />
                        Submitting...
                      </>
                    ) : (
                      'Submit Review'
                    )}
                  </Button>
                </div>
              </div>

              <div className="space-y-3">
                {course.ratings.map((rating) => (
                  <div key={rating._id} className="bg-white rounded-lg border p-3">
                    <div className="flex items-start gap-3">
                      <div className="w-8 h-8 bg-gradient-to-br from-blue-100 to-purple-100 rounded flex items-center justify-center flex-shrink-0">
                        <span className="font-bold text-blue-700 text-xs">
                          {rating.user.firstName.charAt(0)}
                        </span>
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex flex-col mb-2">
                          <p className="font-bold text-gray-900 text-sm">
                            {rating.user.firstName} {rating.user.lastName}
                          </p>
                          <div className="flex items-center gap-0.5 mt-0.5">
                            {[1, 2, 3, 4, 5].map((star) => (
                              <Star
                                key={star}
                                className={`w-3 h-3 ${
                                  star <= rating.rating
                                    ? 'fill-amber-400 text-amber-400'
                                    : 'text-gray-300'
                                }`}
                              />
                            ))}
                          </div>
                        </div>
                        {rating.review && (
                          <p className="text-gray-700 text-sm">{rating.review}</p>
                        )}
                        <span className="text-xs text-gray-500 mt-1.5 block">
                          {new Date(rating.createdAt).toLocaleDateString()}
                        </span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === 'instructor' && course.instructor && (
            <div className="space-y-4">
              <div className="flex items-start gap-3">
                <div className="w-12 h-12 rounded-lg overflow-hidden bg-gradient-to-br from-blue-100 to-purple-100">
                  <img
                    src={course.instructor.avatar || '/placeholder-avatar.jpg'}
                    alt={course.instructor.username}
                    className="w-full h-full object-cover"
                  />
                </div>
                <div>
                  <h3 className="text-lg font-bold text-gray-900">
                    {course.instructor.firstName} {course.instructor.lastName}
                  </h3>
                  <p className="text-gray-600 text-sm mt-0.5">
                    Expert Instructor
                  </p>
                </div>
              </div>

              <div>
                <h4 className="font-bold text-gray-900 mb-2">About Instructor</h4>
                <p className="text-gray-700 text-sm leading-relaxed">
                  {course.instructor.bio || 'Expert instructor with years of experience in the field, dedicated to helping students achieve their goals.'}
                </p>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div className="p-2.5 bg-blue-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <Star className="w-3.5 h-3.5 fill-amber-400 text-amber-400" />
                    <div>
                      <p className="font-bold text-gray-900">
                        {course.instructor.rating?.toFixed(1) || '4.8'}
                      </p>
                      <p className="text-xs text-gray-500">Rating</p>
                    </div>
                  </div>
                </div>
                
                <div className="p-2.5 bg-green-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <Users className="w-3.5 h-3.5 text-green-600" />
                    <div>
                      <p className="font-bold text-gray-900">
                        {course.instructor.totalStudents?.toLocaleString() || '1,000+'}
                      </p>
                      <p className="text-xs text-gray-500">Students</p>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <h4 className="font-bold text-gray-900 mb-2">Expertise</h4>
                <div className="flex flex-wrap gap-1.5">
                  {(course.instructor.expertise || [
                    'Industry Best Practices',
                    'Practical Application',
                    'Career Development'
                  ]).map((expertise, index) => (
                    <Badge 
                      key={index}
                      className="bg-blue-100 text-blue-700 border-0 text-xs px-2 py-0.5"
                    >
                      {expertise}
                    </Badge>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Features Section */}
      <div className="px-4 py-6 bg-gray-50 border-t">
        <h3 className="text-lg font-bold text-gray-900 mb-4">Course Features</h3>
        <div className="grid grid-cols-2 gap-3">
          <FeatureCard
            icon={Shield}
            title="5-Year Access"
            description="Extended access to all materials"
            color="blue"
          />
          
          <FeatureCard
            icon={Award}
            title="Certificate"
            description="Earn upon completion"
            color="green"
          />
          
          <FeatureCard
            icon={Download}
            title="Resources"
            description="Downloadable content"
            color="purple"
          />
          
          <FeatureCard
            icon={Clock}
            title="Self-Paced"
            description="Learn at your own speed"
            color="amber"
          />
        </div>
      </div>

      {/* Mobile Enrollment Footer */}
      <div className="sticky bottom-0 z-40 bg-white border-t shadow-lg">
        <div className="p-4">
          <div className="flex items-center justify-between gap-4">
            <div className="min-w-0">
              <div className="text-xl font-bold text-gray-900">
                {userProgress?.enrolled ? 'Already Enrolled' : course.isFree ? 'Complimentary' : `$${course.price}`}
              </div>
              {!userProgress?.enrolled && !course.isFree && (
                <div className="flex items-center gap-1.5 mt-0.5">
                  <p className="text-gray-500 line-through text-sm">${course.price * 2}</p>
                  <Badge className="bg-green-100 text-green-700 text-xs">
                    50% OFF
                  </Badge>
                </div>
              )}
            </div>
            <div className="flex-shrink-0 w-36">
              <EnrollmentButton />
            </div>
          </div>
        </div>
      </div>

      {course && (
        <PaymentModal
          course={course}
          isOpen={showPaymentModal}
          onClose={() => setShowPaymentModal(false)}
          onSuccess={handlePaymentSuccess}
        />
      )}
    </div>
  )
}


-------------------------
'use client'

import { useState, useEffect, useRef, useCallback, useMemo } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { useToast } from "@/components/ui/use-toast"
import { 
  Star, 
  Users, 
  Clock, 
  PlayCircle, 
  BookOpen, 
  Search,
  Filter,
  Grid,
  List,
  Sparkles,
  Zap,
  Crown,
  TrendingUp,
  Award,
  Shield,
  Globe,
  Download,
  Share2,
  Heart,
  Bookmark,
  Eye,
  ChevronDown,
  ChevronUp,
  Loader2,
  RotateCw,
  Brain,
  Rocket,
  Target,
  BarChart3,
  Video,
  DownloadCloud,
  CheckCircle,
  ArrowRight,
  Flame,
  BookCheck,
  Play,
  Palette,
  Code,
  Music,
  Camera,
  Target as TargetIcon,
  Gauge,
  BatteryCharging,
  Zap as Lightning,
  Calendar,
  ThumbsUp,
  Medal,
  Clock4,
  ShieldCheck,
  X,
  SlidersHorizontal,
  CreditCard,
  Smartphone
} from 'lucide-react'
import { PaymentModal } from '@/components/payment/PaymentModal'

interface S3Asset {
  key: string
  url: string
  size: number
  type: 'image' | 'video'
  duration?: number
  width?: number
  height?: number
}

interface Course {
  _id: string
  title: string
  description: string
  shortDescription: string
  slug: string
  instructor: {
    _id: string
    firstName: string
    lastName: string
    username: string
    avatar?: string
    bio?: string
    rating?: number
    totalStudents?: number
  }
  price: number
  isFree: boolean
  level: 'beginner' | 'intermediate' | 'advanced'
  category: string
  tags: string[]
  thumbnail: S3Asset
  previewVideo?: S3Asset
  totalStudents: number
  averageRating: number
  totalReviews: number
  modules: Array<{
    _id: string
    title: string
    description: string
    order: number
    lessons: Array<{
      _id: string
      title: string
      description: string
      duration: number
      isPreview: boolean
      order: number
    }>
  }>
  totalDuration: number
  totalLessons: number
  isPublished: boolean
  isFeatured: boolean
  requirements: string[]
  learningOutcomes: string[]
  createdAt: string
  updatedAt: string
  enrollmentCount?: number
  completionRate?: number
  aiFeatures?: {
    hasAIAssistant: boolean
    hasPersonalizedLearning: boolean
    hasSmartRecommendations: boolean
    hasProgressTracking: boolean
    hasPersonalizedFeedback: boolean
  }
  students?: Array<{
    user: string
    enrolledAt: Date
    completed?: boolean
  }>
}

interface UserProgress {
  _id: string
  courseId: string
  userId: string
  enrolled: boolean
  progress: number
  completed: boolean
  currentLesson?: string
  lastAccessed?: Date
  timeSpent?: number
  completedLessons: string[]
}

interface FilterState {
  category: string[]
  level: string[]
  price: 'all' | 'free' | 'paid'
  duration: string[]
  features: string[]
  rating: number
  sort: 'popular' | 'newest' | 'rating' | 'duration' | 'price-low' | 'price-high' | 'trending'
}

export default function CoursesPage() {
  const router = useRouter()
  const { toast } = useToast()
  const [courses, setCourses] = useState<Course[]>([])
  const [recommendations, setRecommendations] = useState<Course[]>([])
  const [trendingCourses, setTrendingCourses] = useState<Course[]>([])
  const [loading, setLoading] = useState(true)
  const [streaming, setStreaming] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [searchQuery, setSearchQuery] = useState('')
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid')
  const [showFilters, setShowFilters] = useState(false)
  const [selectedCourse, setSelectedCourse] = useState<Course | null>(null)
  const [isEnrolling, setIsEnrolling] = useState<string | null>(null)
  const [favoriteCourses, setFavoriteCourses] = useState<Set<string>>(new Set())
  const [mobileFiltersOpen, setMobileFiltersOpen] = useState(false)
  const [showPaymentModal, setShowPaymentModal] = useState(false)
  const [enrollingCourse, setEnrollingCourse] = useState<Course | null>(null)
  const observerTarget = useRef<HTMLDivElement>(null)
  const streamController = useRef<AbortController | null>(null)
  const filtersRef = useRef<HTMLDivElement>(null)

  // User progress state
  const [userProgress, setUserProgress] = useState<{[courseId: string]: UserProgress}>({})
  const [progressLoading, setProgressLoading] = useState<Set<string>>(new Set())

  const [filters, setFilters] = useState<FilterState>({
    category: [],
    level: [],
    price: 'all',
    duration: [],
    features: [],
    rating: 0,
    sort: 'popular'
  })

  const [stats, setStats] = useState({
    totalCourses: 0,
    featuredCourses: 0,
    freeCourses: 0,
    totalEnrollments: 0
  })

  // Enhanced filter options with icons
  const filterOptions = {
    categories: [
      { name: 'Fashion Design', icon: Palette },
      { name: 'Pattern Making', icon: TargetIcon },
      { name: 'Sewing', icon: Medal },
      { name: 'Textiles', icon: Gauge },
      { name: 'Fashion Business', icon: TrendingUp },
      { name: 'Sustainability', icon: Globe },
      { name: 'Digital Fashion', icon: Code },
      { name: '3D Design', icon: Camera },
      { name: 'Fashion Marketing', icon: Zap }
    ],
    levels: [
      { name: 'beginner', icon: Rocket, color: 'bg-green-100 text-green-800 border-green-200' },
      { name: 'intermediate', icon: Target, color: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
      { name: 'advanced', icon: Lightning, color: 'bg-red-100 text-red-800 border-red-200' }
    ],
    durations: ['0-2 hours', '2-5 hours', '5-10 hours', '10-20 hours', '20+ hours'],
    features: [
      { name: 'AI Assistant', icon: Brain },
      { name: 'Personalized Learning', icon: Target },
      { name: 'Certification', icon: Award },
      { name: 'Live Sessions', icon: Video },
      { name: 'Community Access', icon: Users },
      { name: 'Lifetime Access', icon: Clock4 },
      { name: 'Project Based', icon: Palette },
      { name: 'Mentor Support', icon: ShieldCheck }
    ]
  }

  // Close mobile filters when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (filtersRef.current && !filtersRef.current.contains(event.target as Node)) {
        setMobileFiltersOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  // Memoized filtered courses for better performance
  const filteredCourses = useMemo(() => {
    return courses.filter(course => {
      // Search filter
      if (searchQuery && !course.title.toLowerCase().includes(searchQuery.toLowerCase()) &&
          !course.shortDescription.toLowerCase().includes(searchQuery.toLowerCase()) &&
          !course.instructor.firstName.toLowerCase().includes(searchQuery.toLowerCase()) &&
          !course.instructor.lastName.toLowerCase().includes(searchQuery.toLowerCase())) {
        return false
      }

      // Category filter
      if (filters.category.length > 0 && !filters.category.includes(course.category)) {
        return false
      }

      // Level filter
      if (filters.level.length > 0 && !filters.level.includes(course.level)) {
        return false
      }

      // Price filter
      if (filters.price === 'free' && !course.isFree) return false
      if (filters.price === 'paid' && course.isFree) return false

      // Rating filter
      if (filters.rating > 0 && course.averageRating < filters.rating) {
        return false
      }

      // Features filter
      if (filters.features.length > 0) {
        const hasFeature = filters.features.some(feature => {
          switch (feature) {
            case 'AI Assistant':
              return course.aiFeatures?.hasAIAssistant
            case 'Personalized Learning':
              return course.aiFeatures?.hasPersonalizedLearning
            case 'Certification':
              return true // Assuming all courses have certification
            case 'Live Sessions':
              return false // You might want to add this field to your Course interface
            default:
              return false
          }
        })
        if (!hasFeature) return false
      }

      return true
    })
  }, [courses, searchQuery, filters])

  // Apply sorting to filtered courses
  const sortedCourses = useMemo(() => {
    const sorted = [...filteredCourses]
    
    switch (filters.sort) {
      case 'popular':
        return sorted.sort((a, b) => b.totalStudents - a.totalStudents)
      case 'trending':
        return sorted.sort((a, b) => (b.enrollmentCount || 0) - (a.enrollmentCount || 0))
      case 'newest':
        return sorted.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
      case 'rating':
        return sorted.sort((a, b) => b.averageRating - a.averageRating)
      case 'duration':
        return sorted.sort((a, b) => b.totalDuration - a.totalDuration)
      case 'price-low':
        return sorted.sort((a, b) => (a.isFree ? 0 : a.price) - (b.isFree ? 0 : b.price))
      case 'price-high':
        return sorted.sort((a, b) => (b.isFree ? 0 : b.price) - (a.isFree ? 0 : a.price))
      default:
        return sorted
    }
  }, [filteredCourses, filters.sort])

  // Active filters count for badge
  const activeFiltersCount = useMemo(() => {
    return (
      (filters.category.length) +
      (filters.level.length) +
      (filters.price !== 'all' ? 1 : 0) +
      (filters.duration.length) +
      (filters.features.length) +
      (filters.rating > 0 ? 1 : 0)
    )
  }, [filters])

  // Fetch progress for a specific course
  const fetchCourseProgress = async (courseId: string) => {
    if (progressLoading.has(courseId)) return
    
    setProgressLoading(prev => new Set([...prev, courseId]))
    
    try {
      const response = await fetch(`/api/courses/${courseId}/progress`)
      
      if (response.ok) {
        const progress = await response.json()
        setUserProgress(prev => ({
          ...prev,
          [courseId]: {
            ...progress,
            enrolled: true
          }
        }))
      } else if (response.status === 403) {
        setUserProgress(prev => ({
          ...prev,
          [courseId]: {
            _id: `temp-${courseId}`,
            courseId,
            userId: 'current-user',
            enrolled: false,
            progress: 0,
            completed: false,
            completedLessons: [],
            lastAccessed: new Date(),
            timeSpent: 0
          }
        }))
      }
    } catch (error) {
      console.error(`Error fetching progress for course ${courseId}:`, error)
      setUserProgress(prev => ({
        ...prev,
        [courseId]: {
          _id: `temp-${courseId}`,
          courseId,
          userId: 'current-user',
          enrolled: false,
          progress: 0,
          completed: false,
          completedLessons: [],
          lastAccessed: new Date(),
          timeSpent: 0
        }
      }))
    } finally {
      setProgressLoading(prev => {
        const newSet = new Set(prev)
        newSet.delete(courseId)
        return newSet
      })
    }
  }

  // Batch fetch progress for courses
  const fetchAllCoursesProgress = async (courseIds: string[]) => {
    // Use Promise.all for parallel fetching with limited concurrency
    const batchSize = 5
    for (let i = 0; i < courseIds.length; i += batchSize) {
      const batch = courseIds.slice(i, i + batchSize)
      await Promise.all(batch.map(courseId => fetchCourseProgress(courseId)))
    }
  }

  // Enhanced enrollment function with proper payment handling
const enrollInCourse = async (course: Course) => {
  if (isEnrolling) return
  
  setIsEnrolling(course._id)
  setError(null)
  
  try {
    const response = await fetch(`/api/courses/${course._id}/enroll`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })

    const result = await response.json()

    // Handle payment required - this is NOT an error, it's a normal flow
    if (response.status === 402 && result.requiresPayment) {
      // Show payment modal for paid courses
      setEnrollingCourse(course)
      setShowPaymentModal(true)
      setIsEnrolling(null)
      return // Exit early - this is not an error
    }

    // Handle other successful responses (200 status)
    if (response.ok) {
      if (result.enrolled) {
        // Handle successful enrollment for free courses
        setCourses(prev => prev.map(c => 
          c._id === course._id 
            ? { 
                ...c, 
                totalStudents: result.course?.totalStudents || c.totalStudents + 1,
                instructor: result.course?.instructor || c.instructor
              }
            : c
        ))
        
        setUserProgress(prev => ({
          ...prev,
          [course._id]: {
            _id: `temp-${course._id}`,
            courseId: course._id,
            userId: 'current-user',
            enrolled: true,
            progress: 0,
            completed: false,
            completedLessons: [],
            lastAccessed: new Date(),
            timeSpent: 0
          }
        }))
        
        toast({
          title: 'Successfully Enrolled!',
          description: 'You can now start learning immediately',
        })

        if (course.slug) {
          setTimeout(() => {
            router.push(`/courses/${course.slug}`)
          }, 1500)
        }
      } 
      // Handle already enrolled case
      else if (result.alreadyEnrolled) {
        toast({
          title: 'Already Enrolled!',
          description: 'You are already enrolled in this course',
        })
        
        // Update UI to show enrolled status
        setUserProgress(prev => ({
          ...prev,
          [course._id]: {
            _id: `temp-${course._id}`,
            courseId: course._id,
            userId: 'current-user',
            enrolled: true,
            progress: result.progress?.progress || 0,
            completed: result.progress?.completed || false,
            completedLessons: result.progress?.completedLessons || [],
            lastAccessed: new Date(),
            timeSpent: result.progress?.timeSpent || 0
          }
        }))
      }
      else {
        throw new Error('Unexpected response from server')
      }
    } else {
      // Handle actual errors (not 402 payment required)
      throw new Error(result.error || `Failed to enroll (${response.status})`)
    }

  } catch (err: any) {
    console.error('Error enrolling:', err)
    
    // Only show error toast for actual errors (not payment flow)
    if (err.message && !err.message.includes('402')) {
      if (err.message.includes('Unauthorized')) {
        toast({
          title: 'Login Required',
          description: 'Please log in to enroll in courses',
          variant: 'destructive',
        })
      } else if (err.message.includes('not found')) {
        toast({
          title: 'Course Not Available',
          description: 'This course is no longer available',
          variant: 'destructive',
        })
      } else {
        toast({
          title: 'Enrollment Failed',
          description: err.message || 'Failed to enroll in course. Please try again.',
          variant: 'destructive',
        })
      }
    }
  } finally {
    setIsEnrolling(null)
  }
}

  // Handle payment success
  const handlePaymentSuccess = (courseId: string) => {
    setUserProgress(prev => ({
      ...prev,
      [courseId]: {
        _id: `temp-${courseId}`,
        courseId,
        userId: 'current-user',
        enrolled: true,
        progress: 0,
        completed: false,
        completedLessons: [],
        lastAccessed: new Date(),
        timeSpent: 0
      }
    }))
    
    setShowPaymentModal(false)
    setEnrollingCourse(null)
    
    // Refresh course data
    fetchCourses(1, false)
    
    toast({
      title: 'üéâ Enrollment Successful!',
      description: 'You have been successfully enrolled in the course',
      variant: 'default',
    })
  }

  // Continue learning - redirect to course detail page
  const continueLearning = (course: Course) => {
    router.push(`/courses/${course.slug}`)
  }

  // View course details
  const viewCourseDetails = (course: Course) => {
    router.push(`/courses/${course.slug}`)
  }

  // Check if user is enrolled in a course
  const isUserEnrolled = (courseId: string) => {
    return userProgress[courseId]?.enrolled || false
  }

  // Enhanced enrollment button with better styling
  const getEnrollmentButton = (course: Course) => {
    const progress = userProgress[course._id]
    const isEnrolled = isUserEnrolled(course._id)
    const isLoading = progressLoading.has(course._id) || isEnrolling === course._id
    
    if (isLoading) {
      return (
        <div className="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-800">
          <Loader2 className="w-4 h-4 animate-spin text-gray-500" />
        </div>
      )
    }

    if (!isEnrolled) {
      return (
        <Button 
          size="sm" 
          className="rounded-lg bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 transition-all shadow-sm hover:shadow"
          onClick={(e) => {
            e.stopPropagation()
            enrollInCourse(course)
          }}
          disabled={isEnrolling === course._id}
        >
          {isEnrolling === course._id ? (
            <Loader2 className="w-4 h-4 animate-spin mr-2" />
          ) : null}
          {course.isFree ? 'Enroll Free' : `Enroll $${course.price}`}
        </Button>
      )
    }

    if (progress?.completed) {
      return (
        <div className="flex items-center space-x-2 px-4 py-2 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
          <CheckCircle className="w-4 h-4 text-green-600 dark:text-green-400" />
          <span className="text-sm font-medium text-green-700 dark:text-green-300">Completed</span>
        </div>
      )
    }

    if (progress?.progress && progress.progress > 0) {
      return (
        <div className="w-full">
          <div className="flex items-center justify-between mb-1.5">
            <span className="text-sm text-gray-600 dark:text-gray-400">{Math.round(progress.progress * 100)}%</span>
          </div>
          <div className="relative h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-2">
            <div 
              className="absolute h-full bg-black dark:bg-white rounded-full transition-all duration-500"
              style={{ width: `${progress.progress * 100}%` }}
            />
          </div>
          <Button 
            size="sm" 
            className="rounded-lg bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 w-full transition-all shadow-sm hover:shadow"
            onClick={(e) => {
              e.stopPropagation()
              continueLearning(course)
            }}
          >
            <Play className="w-4 h-4 mr-2" />
            Continue
          </Button>
        </div>
      )
    }

    return (
      <Button 
        size="sm" 
        className="rounded-lg bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 transition-all shadow-sm hover:shadow w-full"
        onClick={(e) => {
          e.stopPropagation()
          continueLearning(course)
        }}
      >
        <Play className="w-4 h-4 mr-2" />
        Start Learning
      </Button>
    )
  }

  // Enhanced favorite toggle with animation
  const toggleFavorite = (courseId: string) => {
    setFavoriteCourses(prev => {
      const newFavorites = new Set(prev)
      if (newFavorites.has(courseId)) {
        newFavorites.delete(courseId)
        toast({
          title: 'Removed from favorites',
          description: 'Course removed from your favorites',
        })
      } else {
        newFavorites.add(courseId)
        toast({
          title: 'Added to favorites',
          description: 'Course added to your favorites',
        })
      }
      return newFavorites
    })
  }

  // Enhanced share course
  const shareCourse = async (course: Course) => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: course.title,
          text: course.shortDescription,
          url: `${window.location.origin}/courses/${course.slug}`,
        })
      } catch (err) {
        console.log('Share cancelled')
      }
    } else {
      navigator.clipboard.writeText(`${window.location.origin}/courses/${course.slug}`)
      toast({
        title: 'Link copied to clipboard!',
        description: 'Share this course with your friends',
      })
    }
  }

  // Fetch courses with enhanced streaming
  const fetchCourses = useCallback(async (page = 1, isLoadMore = false) => {
    if (streamController.current) {
      streamController.current.abort()
    }

    streamController.current = new AbortController()

    try {
      if (!isLoadMore) {
        setLoading(true)
        setStreaming(true)
        setCourses([])
        setRecommendations([])
        setTrendingCourses([])
        setUserProgress({})
      }
      
      setError(null)

      const params = new URLSearchParams({
        page: page.toString(),
        limit: '12',
        search: searchQuery,
        sort: filters.sort,
        ...(filters.category.length > 0 && { category: filters.category.join(',') }),
        ...(filters.level.length > 0 && { level: filters.level.join(',') }),
        price: filters.price,
        ...(filters.features.length > 0 && { features: filters.features.join(',') }),
        rating: filters.rating.toString()
      })

      const response = await fetch(`/api/courses/stream?${params}`, {
        signal: streamController.current.signal,
        headers: {
          'Accept': 'text/event-stream'
        }
      })

      if (!response.ok) {
        throw new Error(`Failed to fetch courses: ${response.status}`)
      }

      if (response.headers.get('content-type')?.includes('text/event-stream')) {
        const reader = response.body?.getReader()
        if (!reader) throw new Error('Response body is not readable')

        let buffer = ''
        const seenCourseIds = new Set<string>()
        
        while (true) {
          const { done, value } = await reader.read()
          if (done) break

          const chunk = new TextDecoder().decode(value)
          buffer += chunk

          const lines = buffer.split('\n')
          buffer = lines.pop() || ''

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6))
                
                switch (data.type) {
                  case 'stats':
                    setStats(data.stats)
                    break
                  case 'course':
                    if (!seenCourseIds.has(data.course._id)) {
                      seenCourseIds.add(data.course._id)
                      if (isLoadMore) {
                        setCourses(prev => {
                          const existingIds = new Set(prev.map(c => c._id))
                          return existingIds.has(data.course._id) 
                            ? prev 
                            : [...prev, data.course]
                        })
                      } else {
                        setCourses(prev => [...prev, data.course])
                      }
                    }
                    break
                  case 'recommendation':
                    setRecommendations(prev => {
                      const existingIds = new Set(prev.map(c => c._id))
                      return existingIds.has(data.course._id) 
                        ? prev 
                        : [...prev, data.course]
                    })
                    break
                  case 'trending':
                    setTrendingCourses(prev => {
                      const existingIds = new Set(prev.map(c => c._id))
                      return existingIds.has(data.course._id) 
                        ? prev 
                        : [...prev, data.course]
                    })
                    break
                  case 'complete':
                    setStreaming(false)
                    break
                  case 'error':
                    console.error('Stream error:', data.message)
                    break
                }
              } catch (e) {
                console.warn('Failed to parse stream data:', e)
              }
            }
          }
        }
      }
    } catch (err: any) {
      if (err.name === 'AbortError') return
      console.error('Error fetching courses:', err)
      setError(err.message || 'Failed to load courses')
    } finally {
      setLoading(false)
      setStreaming(false)
    }
  }, [searchQuery, filters])

  // Load more courses
  const loadMoreCourses = useCallback(async () => {
    if (!streaming && courses.length > 0) {
      const currentPage = Math.ceil(courses.length / 12)
      await fetchCourses(currentPage + 1, true)
    }
  }, [streaming, courses.length, fetchCourses])

  // Intersection Observer for infinite scroll
  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting && !streaming && !loading) {
          loadMoreCourses()
        }
      },
      { threshold: 0.1 }
    )

    if (observerTarget.current) {
      observer.observe(observerTarget.current)
    }

    return () => {
      if (observerTarget.current) {
        observer.unobserve(observerTarget.current)
      }
    }
  }, [streaming, loading, loadMoreCourses])

  // Initial load and filter changes
  useEffect(() => {
    fetchCourses(1, false)
  }, [searchQuery, filters, fetchCourses])

  // Fetch progress for courses when they are loaded
  useEffect(() => {
    if (courses.length > 0) {
      const courseIds = courses.map(course => course._id)
      fetchAllCoursesProgress(courseIds)
    }
  }, [courses.length])

  // Toggle filters
  const toggleFilter = (type: keyof FilterState, value: string) => {
    setFilters(prev => {
      const currentArray = prev[type] as string[]
      if (Array.isArray(currentArray)) {
        return {
          ...prev,
          [type]: currentArray.includes(value)
            ? currentArray.filter(item => item !== value)
            : [...currentArray, value]
        }
      }
      return prev
    })
  }

  // Clear all filters
  const clearFilters = () => {
    setFilters({
      category: [],
      level: [],
      price: 'all',
      duration: [],
      features: [],
      rating: 0,
      sort: 'popular'
    })
  }

  // Format duration
  const formatDuration = (minutes: number) => {
    const hours = Math.floor(minutes / 60)
    const mins = minutes % 60
    if (hours > 0) {
      return `${hours}h ${mins > 0 ? `${mins}m` : ''}`.trim()
    }
    return `${mins}m`
  }

  // Get level color
  const getLevelColor = (level: string) => {
    switch (level) {
      case 'beginner':
        return 'bg-green-100 text-green-800 border-green-200'
      case 'intermediate':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200'
      case 'advanced':
        return 'bg-red-100 text-red-800 border-red-200'
      default:
        return 'bg-gray-100 text-gray-800 border-gray-200'
    }
  }

  // Course Skeleton
  const CourseSkeleton = () => (
    <Card className="rounded-xl overflow-hidden animate-pulse border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900">
      <div className="h-44 bg-gray-200 dark:bg-gray-800"></div>
      <CardHeader className="pb-4 px-5">
        <div className="h-5 bg-gray-200 dark:bg-gray-800 rounded mb-3 w-4/5"></div>
        <div className="h-4 bg-gray-200 dark:bg-gray-800 rounded w-3/4"></div>
      </CardHeader>
      <CardContent className="pb-5 px-5">
        <div className="flex justify-between items-center">
          <div className="h-6 bg-gray-200 dark:bg-gray-800 rounded w-20"></div>
          <div className="h-9 bg-gray-200 dark:bg-gray-800 rounded-lg w-24"></div>
        </div>
      </CardContent>
    </Card>
  )

  // Quick View Modal
  const QuickViewModal = ({ course, onClose }: { course: Course, onClose: () => void }) => {
    const progress = userProgress[course._id]
    const isEnrolled = isUserEnrolled(course._id)
    const isLoading = progressLoading.has(course._id)
    
    return (
      <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div className="bg-white dark:bg-gray-900 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-800 shadow-2xl">
          <div className="relative">
            <img
              src={course.thumbnail.url}
              alt={course.title}
              className="w-full h-56 object-cover rounded-t-xl"
            />
            <button
              onClick={onClose}
              className="absolute top-4 right-4 bg-white dark:bg-gray-900 rounded-lg p-2 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors shadow-lg"
            >
              <X className="w-5 h-5" />
            </button>
            
            {/* Badges */}
            <div className="absolute top-4 left-4 flex flex-wrap gap-2">
              <Badge className={`rounded-lg ${getLevelColor(course.level)} border`}>
                {course.level}
              </Badge>
              {course.isFree && (
                <Badge className="rounded-lg bg-green-500 text-white border-0">
                  Free
                </Badge>
              )}
            </div>
          </div>
          
          <div className="p-6">
            <div className="flex items-start justify-between mb-4">
              <div className="flex-1">
                <h2 className="text-2xl font-bold mb-3">
                  {course.title}
                </h2>
                <p className="text-gray-600 dark:text-gray-400">{course.shortDescription}</p>
              </div>
              <span className="text-2xl font-bold text-black dark:text-white ml-4">
                {course.isFree ? 'Free' : `$${course.price}`}
              </span>
            </div>

            {/* Instructor Info */}
            <div className="flex items-center space-x-3 mb-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
              <img
                src={course.instructor.avatar || '/default-avatar.png'}
                alt={course.instructor.username}
                className="w-10 h-10 rounded-lg"
                onError={(e) => {
                  const target = e.target as HTMLImageElement
                  target.src = '/default-avatar.png'
                }}
              />
              <div>
                <p className="font-medium">
                  {course.instructor.firstName} {course.instructor.lastName}
                </p>
                <p className="text-sm text-gray-500">
                  {course.instructor.totalStudents || 0}+ students
                </p>
              </div>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="text-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                <div className="text-lg font-bold text-black dark:text-white">{course.totalLessons}</div>
                <div className="text-sm text-gray-500">Lessons</div>
              </div>
              <div className="text-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                <div className="flex items-center justify-center text-lg font-bold text-black dark:text-white">
                  <Star className="w-4 h-4 fill-yellow-400 text-yellow-400 mr-1" />
                  {course.averageRating > 0 ? course.averageRating.toFixed(1) : 'New'}
                </div>
                <div className="text-sm text-gray-500">Rating</div>
              </div>
              <div className="text-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                <div className="text-lg font-bold text-black dark:text-white">{formatDuration(course.totalDuration)}</div>
                <div className="text-sm text-gray-500">Duration</div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="space-y-3">
              {isLoading ? (
                <div className="flex items-center justify-center px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-800">
                  <Loader2 className="w-5 h-5 animate-spin text-gray-500" />
                </div>
              ) : isEnrolled ? (
                progress?.completed ? (
                  <div className="flex items-center justify-center space-x-2 px-4 py-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
                    <CheckCircle className="w-5 h-5 text-green-600 dark:text-green-400" />
                    <span className="font-medium text-green-700 dark:text-green-300">Course Completed</span>
                  </div>
                ) : (
                  <Button 
                    onClick={() => {
                      onClose()
                      continueLearning(course)
                    }}
                    className="w-full rounded-lg bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 py-3 text-base"
                  >
                    <Play className="w-5 h-5 mr-2" />
                    {progress?.progress && progress.progress > 0 ? 'Continue Learning' : 'Start Learning'}
                  </Button>
                )
              ) : (
                <Button 
                  className="w-full rounded-lg bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 py-3 text-base"
                  onClick={() => enrollInCourse(course)}
                  disabled={isEnrolling === course._id}
                >
                  {isEnrolling === course._id ? (
                    <Loader2 className="w-5 h-5 animate-spin mr-2" />
                  ) : (
                    <BookCheck className="w-5 h-5 mr-2" />
                  )}
                  {isEnrolling === course._id ? 'Enrolling...' : course.isFree ? 'Enroll Free' : `Enroll for $${course.price}`}
                </Button>
              )}
              <Button 
                onClick={() => {
                  onClose()
                  viewCourseDetails(course)
                }}
                variant="outline" 
                className="w-full rounded-lg border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 py-3 text-base"
              >
                <BookOpen className="w-5 h-5 mr-2" />
                View Full Details
              </Button>
            </div>
          </div>
        </div>
      </div>
    )
  }

  // Filters Sidebar Component
  const FiltersSidebar = () => (
    <Card className="rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 lg:sticky lg:top-6">
      <CardHeader className="pb-4">
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center text-lg">
            <Filter className="w-5 h-5 mr-2 text-gray-600 dark:text-gray-400" />
            Filters
            {activeFiltersCount > 0 && (
              <Badge className="ml-2 bg-black text-white dark:bg-white dark:text-black rounded-full px-2 py-0.5 text-xs">
                {activeFiltersCount}
              </Badge>
            )}
          </CardTitle>
          <Button 
            variant="ghost" 
            size="sm" 
            onClick={clearFilters}
            className="rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-sm"
          >
            Clear all
          </Button>
        </div>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Sort Filter */}
        <div>
          <h4 className="font-medium mb-3 text-sm text-gray-700 dark:text-gray-300">
            Sort by
          </h4>
          <select
            value={filters.sort}
            onChange={(e) => setFilters(prev => ({ ...prev, sort: e.target.value as any }))}
            className="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent"
          >
            <option value="popular">Most Popular</option>
            <option value="newest">Newest</option>
            <option value="rating">Highest Rated</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
          </select>
        </div>

        {/* Price Filter */}
        <div>
          <h4 className="font-medium mb-3 text-sm text-gray-700 dark:text-gray-300">
            Price
          </h4>
          <div className="space-y-2">
            {[
              { value: 'all', label: 'All Courses' },
              { value: 'free', label: 'Free Only' },
              { value: 'paid', label: 'Paid Only' }
            ].map((price) => (
              <label key={price.value} className="flex items-center space-x-3 cursor-pointer group">
                <input
                  type="radio"
                  name="price"
                  value={price.value}
                  checked={filters.price === price.value}
                  onChange={() => setFilters(prev => ({ ...prev, price: price.value as any }))}
                  className="w-4 h-4 text-black dark:text-white border-gray-300 dark:border-gray-600"
                />
                <span className="text-sm">{price.label}</span>
              </label>
            ))}
          </div>
        </div>

        {/* Level Filter */}
        <div>
          <h4 className="font-medium mb-3 text-sm text-gray-700 dark:text-gray-300">
            Level
          </h4>
          <div className="space-y-2">
            {filterOptions.levels.map((level) => (
              <label key={level.name} className="flex items-center space-x-3 cursor-pointer group">
                <input
                  type="checkbox"
                  checked={filters.level.includes(level.name)}
                  onChange={() => toggleFilter('level', level.name)}
                  className="w-4 h-4 text-black dark:text-white rounded border-gray-300 dark:border-gray-600"
                />
                <span className={`px-3 py-1.5 rounded text-xs font-medium ${level.color} border`}>
                  {level.name.charAt(0).toUpperCase() + level.name.slice(1)}
                </span>
              </label>
            ))}
          </div>
        </div>

        {/* Category Filter */}
        <div>
          <h4 className="font-medium mb-3 text-sm text-gray-700 dark:text-gray-300">
            Category
          </h4>
          <div className="space-y-2">
            {filterOptions.categories.slice(0, 5).map((category) => (
              <label key={category.name} className="flex items-center space-x-3 cursor-pointer group">
                <input
                  type="checkbox"
                  checked={filters.category.includes(category.name)}
                  onChange={() => toggleFilter('category', category.name)}
                  className="w-4 h-4 text-black dark:text-white rounded border-gray-300 dark:border-gray-600"
                />
                <span className="text-sm">{category.name}</span>
              </label>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  )

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-black">
      {/* Main Content */}
      <div className="container mx-auto px-4 py-8">
        {/* Header Section */}
        <div className="mb-10">
          <div className="text-center mb-8">
            <h1 className="text-3xl md:text-4xl font-bold mb-3">
              Fashion Design Courses
            </h1>
            <p className="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
              Master your craft with expert-led courses in fashion design, pattern making, and more
            </p>
          </div>
          
          {/* Search Bar */}
          <div className="max-w-2xl mx-auto">
            <div className="relative">
              <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <Input
                type="text"
                placeholder="Search for courses, topics, or instructors..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-12 pr-4 py-3 rounded-xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-base shadow-sm focus:shadow-md transition-shadow"
              />
            </div>
          </div>
        </div>

        <div className="flex flex-col lg:flex-row gap-8">
          {/* Filters Sidebar - Desktop */}
          <div className="hidden lg:block lg:w-64 space-y-6">
            <FiltersSidebar />
          </div>

          {/* Mobile Filters Overlay */}
          {mobileFiltersOpen && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 lg:hidden">
              <div 
                ref={filtersRef}
                className="absolute left-0 top-0 h-full w-80 max-w-[90vw] bg-white dark:bg-gray-900 shadow-xl overflow-y-auto"
              >
                <FiltersSidebar />
              </div>
            </div>
          )}

          {/* Courses Grid */}
          <div className="flex-1">
            {/* Controls */}
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
              <div>
                <h2 className="text-xl font-semibold mb-1">
                  {searchQuery ? `Search results for "${searchQuery}"` : 'All Courses'}
                </h2>
                <p className="text-gray-500 text-sm">
                  {sortedCourses.length} courses
                </p>
              </div>
              
              <div className="flex items-center space-x-3">
                {/* Mobile Filters Button */}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setMobileFiltersOpen(true)}
                  className="rounded-lg border-gray-300 dark:border-gray-700 lg:hidden"
                >
                  <Filter className="w-4 h-4 mr-2" />
                  Filters
                  {activeFiltersCount > 0 && (
                    <span className="ml-2 bg-black text-white dark:bg-white dark:text-black rounded-full w-5 h-5 text-xs flex items-center justify-center">
                      {activeFiltersCount}
                    </span>
                  )}
                </Button>

                {/* View Toggle */}
                <div className="flex bg-gray-100 dark:bg-gray-900 rounded-lg p-1">
                  <Button
                    variant={viewMode === 'grid' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('grid')}
                    className="rounded-md h-9 px-3"
                  >
                    <Grid className="w-4 h-4" />
                  </Button>
                  <Button
                    variant={viewMode === 'list' ? 'default' : 'ghost'}
                    size="sm"
                    onClick={() => setViewMode('list')}
                    className="rounded-md h-9 px-3"
                  >
                    <List className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </div>

            {/* Courses Grid */}
            {loading && courses.length === 0 ? (
              <div className={`grid gap-6 ${
                viewMode === 'grid' 
                  ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' 
                  : 'grid-cols-1'
              }`}>
                {Array.from({ length: 6 }).map((_, index) => (
                  <CourseSkeleton key={index} />
                ))}
              </div>
            ) : sortedCourses.length === 0 ? (
              <div className="text-center py-16">
                <div className="inline-block p-6 bg-gray-100 dark:bg-gray-900 rounded-2xl mb-6">
                  <BookOpen className="w-12 h-12 text-gray-400" />
                </div>
                <h3 className="text-xl font-semibold mb-2">No courses found</h3>
                <p className="text-gray-500 mb-6 max-w-sm mx-auto">
                  Try adjusting your search or filters
                </p>
                <Button onClick={clearFilters} variant="outline" className="rounded-lg">
                  Clear filters
                </Button>
              </div>
            ) : (
              <>
                <div className={`grid gap-6 ${
                  viewMode === 'grid' 
                    ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' 
                    : 'grid-cols-1'
                }`}>
                  {sortedCourses.map((course) => {
                    const progress = userProgress[course._id]
                    const isEnrolled = isUserEnrolled(course._id)
                    
                    return (
                      <Card 
                        key={course._id} 
                        className="group rounded-xl overflow-hidden hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 cursor-pointer"
                        onClick={() => setSelectedCourse(course)}
                      >
                        {/* Course Thumbnail */}
                        <div className="relative h-44 bg-gray-200 dark:bg-gray-800 overflow-hidden">
                          <img
                            src={course.thumbnail.url}
                            alt={course.title}
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          />
                          <div className="absolute top-3 left-3">
                            <Badge className={`rounded-lg ${getLevelColor(course.level)} border shadow-sm`}>
                              {course.level}
                            </Badge>
                          </div>
                          {course.isFree && (
                            <div className="absolute top-3 right-3">
                              <Badge className="rounded-lg bg-green-500 text-white border-0 shadow-sm">
                                Free
                              </Badge>
                            </div>
                          )}
                        </div>
                        
                        <CardHeader className="pb-4 px-5 pt-5">
                          <CardTitle className="text-lg font-semibold mb-2 line-clamp-2 group-hover:text-gray-700 dark:group-hover:text-gray-300 transition-colors">
                            {course.title}
                          </CardTitle>
                          <CardDescription className="line-clamp-2 text-gray-600 dark:text-gray-400 text-sm">
                            {course.shortDescription}
                          </CardDescription>
                        </CardHeader>
                        
                        <CardContent className="pb-5 px-5">
                          {/* Instructor and Rating */}
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <div className="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center overflow-hidden">
                                <img
                                  src={course.instructor.avatar || '/default-avatar.png'}
                                  alt={course.instructor.username}
                                  className="w-full h-full object-cover"
                                  onError={(e) => {
                                    const target = e.target as HTMLImageElement
                                    target.src = '/default-avatar.png'
                                  }}
                                />
                              </div>
                              <span className="text-sm font-medium">
                                {course.instructor.firstName}
                              </span>
                            </div>
                            <div className="flex items-center space-x-1">
                              <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                              <span className="text-sm font-medium">{course.averageRating > 0 ? course.averageRating.toFixed(1) : 'New'}</span>
                            </div>
                          </div>
                          
                          {/* Enrollment Button */}
                          {getEnrollmentButton(course)}
                        </CardContent>
                      </Card>
                    )
                  })}
                </div>

                {/* Load More */}
                {!loading && (
                  <div ref={observerTarget} className="flex justify-center mt-12">
                    {streaming ? (
                      <div className="flex items-center space-x-3 px-6 py-3 rounded-lg bg-gray-100 dark:bg-gray-900">
                        <Loader2 className="w-5 h-5 animate-spin text-gray-500" />
                        <span className="text-sm text-gray-500">Loading more courses...</span>
                      </div>
                    ) : (
                      <Button 
                        onClick={loadMoreCourses}
                        variant="outline"
                        className="rounded-lg border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 px-8 py-3"
                      >
                        <DownloadCloud className="w-5 h-5 mr-2" />
                        Load More Courses
                      </Button>
                    )}
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      </div>

      {/* Quick View Modal */}
      {selectedCourse && (
        <QuickViewModal 
          course={selectedCourse} 
          onClose={() => setSelectedCourse(null)} 
        />
      )}

      {/* Payment Modal */}
      {enrollingCourse && (
        <PaymentModal
          course={enrollingCourse}
          isOpen={showPaymentModal}
          onClose={() => {
            setShowPaymentModal(false)
            setEnrollingCourse(null)
          }}
          onSuccess={handlePaymentSuccess}
        />
      )}
    </div>
  )
}
--------------------------
// app/admin/courses/create/page.tsx
'use client'

import { useState, useRef, useEffect, forwardRef } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@clerk/nextjs'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { 
  Plus, 
  Trash2, 
  Upload, 
  X, 
  Save, 
  BookOpen,
  Video,
  Image,
  FileText,
  Clock,
  Users,
  Star,
  Eye,
  EyeOff,
  Play,
  CheckCircle,
  AlertCircle,
  CloudUpload
} from 'lucide-react'

interface S3Asset {
  key: string
  url: string
  size: number
  type: 'image' | 'video'
  duration?: number
  width?: number
  height?: number
}

interface UploadProgress {
  [key: string]: {
    progress: number
    fileName: string
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo'
    status: 'generating-url' | 'uploading' | 'processing' | 'completed' | 'error'
    error?: string
  }
}

interface Lesson {
  title: string
  description: string
  content: string
  video?: S3Asset
  duration: number
  isPreview: boolean
  resources: {
    title: string
    url: string
    type: 'pdf' | 'document' | 'link' | 'video'
  }[]
  order: number
}

interface Module {
  title: string
  description: string
  lessons: Lesson[]
  order: number
}

// Upload Optimization Tips Component
const UploadOptimizationTips = ({ fileSize }: { fileSize: number }) => {
  const sizeInMB = fileSize / (1024 * 1024)
  
  return (
    <Card className="rounded-2xl border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-900/20">
      <CardContent className="p-4">
        <div className="flex items-start space-x-3">
          <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
          <div className="flex-1">
            <p className="text-sm font-medium text-yellow-800 dark:text-yellow-300 mb-2">
              Large File Upload in Progress ({sizeInMB.toFixed(2)}MB)
            </p>
            <ul className="text-xs text-yellow-700 dark:text-yellow-400 space-y-1">
              <li>‚Ä¢ Keep this page open during upload</li>
              <li>‚Ä¢ Use a stable internet connection</li>
              <li>‚Ä¢ Avoid uploading multiple large files simultaneously</li>
              <li>‚Ä¢ Upload time depends on your internet speed</li>
            </ul>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}

// Custom hook for S3 file uploads with Clerk auth
const useS3Upload = () => {
  const [uploadProgress, setUploadProgress] = useState<UploadProgress>({})
  const { getToken, userId } = useAuth()

  const uploadFile = async (
    file: File,
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo',
    identifier: string
  ) => {
    const maxSize = type === 'thumbnail' ? 5 * 1024 * 1024 : 5 * 1024 * 1024 * 1024
    if (file.size > maxSize) {
      throw new Error(
        `File too large. Maximum size: ${type === 'thumbnail' ? '5MB' : '5GB'}`
      )
    }

    // Calculate dynamic timeout (1 minute per 100MB + 10 minutes buffer)
    const timeoutDuration = Math.max(
      10 * 60 * 1000, // Minimum 10 minutes
      Math.ceil(file.size / (100 * 1024 * 1024)) * 60 * 1000 + 10 * 60 * 1000
    )

    try {
      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          progress: 0, 
          fileName: file.name, 
          type,
          status: 'generating-url'
        }
      }))

      console.log('üîê Getting Clerk token...')
      const token = await getToken()
      
      if (!token || !userId) {
        throw new Error('Authentication failed. Please sign in again.')
      }

      console.log('‚úÖ Token obtained, making upload request...')

      // Get presigned URL
      const presignedResponse = await fetch('/api/admin/upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          folder: `${type}s`
        }),
      })

      console.log('üì° Upload API response status:', presignedResponse.status)

      if (!presignedResponse.ok) {
        const errorText = await presignedResponse.text()
        let errorData
        try {
          errorData = JSON.parse(errorText)
        } catch {
          errorData = { error: 'Failed to get upload URL' }
        }
        throw new Error(errorData.error || `Upload failed with status: ${presignedResponse.status}`)
      }

      const { presignedUrl, fileUrl, fileKey } = await presignedResponse.json()

      console.log('‚úÖ Presigned URL received, starting upload...')
      console.log(`‚è∞ Using timeout: ${timeoutDuration / 1000 / 60} minutes for ${(file.size / (1024 * 1024)).toFixed(2)}MB file`)

      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          ...prev[identifier], 
          status: 'uploading',
          progress: 5
        }
      }))

      // Enhanced upload with better progress tracking
      const uploadResult = await new Promise<S3Asset>((resolve, reject) => {
        const xhr = new XMLHttpRequest()
        const uploadStartTime = Date.now()
        let lastProgressUpdate = Date.now()
        let lastLoaded = 0

        xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
            const currentTime = Date.now()
            const progress = 5 + (event.loaded / event.total) * 90 // 5% to 95%
            
            // Calculate speed (only update every 500ms to reduce noise)
            if (currentTime - lastProgressUpdate > 500) {
              const timeDiff = (currentTime - lastProgressUpdate) / 1000
              const loadedDiff = event.loaded - lastLoaded
              const uploadSpeed = loadedDiff / timeDiff // bytes per second
              
              console.log(`üìä Upload progress: ${Math.round(progress)}% - Speed: ${(uploadSpeed / (1024 * 1024)).toFixed(2)} MB/s`)
              
              lastProgressUpdate = currentTime
              lastLoaded = event.loaded
            }

            setUploadProgress(prev => ({
              ...prev,
              [identifier]: { 
                ...prev[identifier], 
                progress: Math.round(progress)
              }
            }))
          }
        })

        xhr.addEventListener('load', () => {
          const uploadTime = (Date.now() - uploadStartTime) / 1000
          console.log(`‚úÖ Upload completed in ${uploadTime} seconds`)
          
          if (xhr.status === 200) {
            setUploadProgress(prev => ({
              ...prev,
              [identifier]: { 
                ...prev[identifier], 
                progress: 100,
                status: 'completed'
              }
            }))

            resolve({
              key: fileKey,
              url: fileUrl,
              size: file.size,
              type: type === 'thumbnail' ? 'image' : 'video',
              duration: type !== 'thumbnail' ? 0 : undefined
            })
          } else {
            console.error('‚ùå Upload failed with status:', xhr.status)
            reject(new Error(`Upload failed with status: ${xhr.status}`))
          }
        })

        xhr.addEventListener('error', (e) => {
          console.error('‚ùå Network error during upload:', e)
          reject(new Error('Network error during upload. Please check your connection.'))
        })

        xhr.addEventListener('abort', () => {
          console.error('‚ùå Upload was cancelled')
          reject(new Error('Upload was cancelled'))
        })

        // Set timeout and handle timeout gracefully
        xhr.timeout = timeoutDuration
        xhr.ontimeout = () => {
          const elapsed = (Date.now() - uploadStartTime) / 1000
          const uploadedMB = (lastLoaded / (1024 * 1024)).toFixed(2)
          console.error(`‚ùå Upload timeout after ${elapsed} seconds, uploaded: ${uploadedMB}MB`)
          reject(new Error(`Upload timeout after ${Math.round(elapsed / 60)} minutes. Uploaded ${uploadedMB}MB of ${(file.size / (1024 * 1024)).toFixed(2)}MB.`))
        }

        console.log('üì§ Starting direct upload to S3...')
        xhr.open('PUT', presignedUrl)
        xhr.setRequestHeader('Content-Type', file.type)
        // Remove unsafe headers - browser will set Content-Length automatically
        
        xhr.send(file)
      })

      // Clear progress after success
      setTimeout(() => {
        setUploadProgress(prev => {
          const newProgress = { ...prev }
          delete newProgress[identifier]
          return newProgress
        })
      }, 3000)

      return uploadResult

    } catch (error) {
      console.error('‚ùå Upload error:', error)
      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          ...prev[identifier], 
          status: 'error',
          error: error instanceof Error ? error.message : 'Upload failed'
        }
      }))
      throw error
    }
  }

  const cancelUpload = (identifier: string) => {
    console.log('üö´ Cancelling upload:', identifier)
    setUploadProgress(prev => {
      const newProgress = { ...prev }
      delete newProgress[identifier]
      return newProgress
    })
  }

  return { uploadProgress, uploadFile, cancelUpload }
}

// File Upload Area Component
const FileUploadArea = ({
  type,
  label,
  acceptedFiles,
  maxSize,
  currentFile,
  onFileChange,
  moduleIndex,
  lessonIndex,
  uploadProgress,
  onCancelUpload
}: {
  type: 'thumbnail' | 'previewVideo' | 'lessonVideo'
  label: string
  acceptedFiles: string
  maxSize: string
  currentFile: S3Asset | null
  onFileChange: (e: React.ChangeEvent<HTMLInputElement>) => void
  moduleIndex?: number
  lessonIndex?: number
  uploadProgress?: UploadProgress
  onCancelUpload?: (identifier: string) => void
}) => {
  const inputRef = useRef<HTMLInputElement>(null)
  const uploadId = type === 'lessonVideo' ? `lesson-${moduleIndex}-${lessonIndex}` : type
  const upload = uploadProgress?.[uploadId]
  const isUploading = upload?.status === 'generating-url' || upload?.status === 'uploading'

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  const getStatusColor = () => {
    switch (upload?.status) {
      case 'generating-url': return 'bg-blue-500'
      case 'uploading': return 'bg-blue-500'
      case 'processing': return 'bg-yellow-500'
      case 'completed': return 'bg-green-500'
      case 'error': return 'bg-red-500'
      default: return 'bg-gray-500'
    }
  }

  const getStatusIcon = () => {
    switch (upload?.status) {
      case 'generating-url': return <CloudUpload className="w-4 h-4" />
      case 'uploading': return <CloudUpload className="w-4 h-4" />
      case 'processing': return <AlertCircle className="w-4 h-4" />
      case 'completed': return <CheckCircle className="w-4 h-4" />
      case 'error': return <AlertCircle className="w-4 h-4" />
      default: return <CloudUpload className="w-4 h-4" />
    }
  }

  const getStatusText = () => {
    switch (upload?.status) {
      case 'generating-url': return 'Preparing upload...'
      case 'uploading': return `Uploading... ${upload.progress}%`
      case 'processing': return 'Processing...'
      case 'completed': return 'Upload completed'
      case 'error': return 'Upload failed'
      default: return 'Uploading...'
    }
  }

  return (
    <div className="space-y-4">
      <label className="text-sm font-medium flex items-center space-x-2">
        {type === 'thumbnail' ? <Image className="w-4 h-4" /> : <Video className="w-4 h-4" />}
        <span>{label}</span>
      </label>
      
      <input
        ref={inputRef}
        type="file"
        accept={acceptedFiles}
        onChange={onFileChange}
        className="hidden"
        disabled={isUploading}
      />
      
      <div 
        className={`border-2 border-dashed rounded-2xl p-6 text-center cursor-pointer transition-colors ${
          isUploading 
            ? 'border-blue-300 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/20 cursor-not-allowed' 
            : 'border-slate-300 dark:border-slate-600 hover:border-rose-400'
        }`}
        onClick={() => !isUploading && inputRef.current?.click()}
      >
        {currentFile ? (
          <div className="space-y-2">
            {type === 'thumbnail' ? (
              <img
                src={currentFile.url}
                alt="Preview"
                className="w-32 h-32 object-cover rounded-xl mx-auto"
              />
            ) : (
              <div className="relative">
                <video className="w-32 h-32 object-cover rounded-xl mx-auto">
                  <source src={currentFile.url} type="video/mp4" />
                </video>
                <Play className="w-6 h-6 text-white absolute inset-0 m-auto" />
              </div>
            )}
            <p className="text-sm text-slate-600">Click to change</p>
            <p className="text-xs text-slate-500">
              {formatFileSize(currentFile.size)}
              {currentFile.duration && type !== 'thumbnail' && ` ‚Ä¢ ${currentFile.duration}s`}
            </p>
          </div>
        ) : (
          <div className="space-y-2">
            {type === 'thumbnail' ? (
              <Image className="w-8 h-8 text-slate-400 mx-auto" />
            ) : (
              <Video className="w-8 h-8 text-slate-400 mx-auto" />
            )}
            <p className="text-sm font-medium">
              {isUploading ? 'Uploading...' : `Upload ${type === 'thumbnail' ? 'Thumbnail' : 'Video'}`}
            </p>
            <p className="text-xs text-slate-500">
              {acceptedFiles.split(',').join(', ')} up to {maxSize}
            </p>
            {type !== 'thumbnail' && (
              <p className="text-xs text-blue-500 mt-1">
                Large files supported (up to 5GB)
              </p>
            )}
          </div>
        )}
      </div>
      
      {/* Upload Progress */}
      {upload && (
        <div className="flex items-center space-x-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
          <div className={`p-1 rounded-full ${getStatusColor()} text-white`}>
            {getStatusIcon()}
          </div>
          <div className="flex-1">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium truncate max-w-[200px]">
                {upload.fileName}
              </span>
              <span className="text-slate-500">
                {getStatusText()}
              </span>
            </div>
            {(upload.status === 'generating-url' || upload.status === 'uploading') && (
              <Progress value={upload.progress} className="h-2 mt-1" />
            )}
            {upload.status === 'error' && upload.error && (
              <p className="text-xs text-red-500 mt-1">{upload.error}</p>
            )}
          </div>
          {(upload.status === 'generating-url' || upload.status === 'uploading') && onCancelUpload && (
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => onCancelUpload(uploadId)}
              className="text-red-500 hover:text-red-600"
            >
              <X className="w-4 h-4" />
            </Button>
          )}
        </div>
      )}
    </div>
  )
}

export default function CreateCoursePage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [isClient, setIsClient] = useState(false)
  const [userRole, setUserRole] = useState<string | null>(null)
  const [checkingAuth, setCheckingAuth] = useState(true)
  const { uploadProgress, uploadFile, cancelUpload } = useS3Upload()
  const { isSignedIn, isLoaded, userId } = useAuth()

  const [formData, setFormData] = useState({
    title: '',
    description: '',
    shortDescription: '',
    price: 0,
    isFree: false,
    level: 'beginner' as 'beginner' | 'intermediate' | 'advanced',
    category: '',
    tags: [] as string[],
    thumbnail: null as S3Asset | null,
    previewVideo: null as S3Asset | null,
    modules: [] as Module[],
    requirements: [] as string[],
    learningOutcomes: [] as string[],
    isFeatured: false
  })

  const [newTag, setNewTag] = useState('')
  const [newRequirement, setNewRequirement] = useState('')
  const [newOutcome, setNewOutcome] = useState('')

  // Helper functions
  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  const formatDuration = (minutes: number) => {
    const hours = Math.floor(minutes / 60)
    const mins = minutes % 60
    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`
  }

  // Set client-side flag
  useEffect(() => {
    setIsClient(true)
  }, [])

  // Check user role from MongoDB using the /api/users/me endpoint
  useEffect(() => {
    const checkUserRole = async () => {
      if (isLoaded && isClient && isSignedIn && userId) {
        try {
          setCheckingAuth(true)
          console.log('üîç Checking user role via /api/users/me...')
          
          const response = await fetch('/api/users/me')
          
          if (response.ok) {
            const data = await response.json()
            console.log('‚úÖ User data from API:', data)
            
            // Check the actual response structure
            const userData = data.user || data
            console.log('üë§ Extracted user data:', userData)
            
            // Check if user has admin role in MongoDB
            if (userData.role === 'admin') {
              setUserRole('admin')
              console.log('üéâ User is admin, allowing access')
            } else {
              setUserRole(userData.role || 'user')
              console.log('‚ùå User is not admin, denying access. Role:', userData.role)
            }
          } else {
            console.error('‚ùå Failed to fetch user data:', response.status)
            setUserRole(null)
          }
        } catch (error) {
          console.error('‚ùå Error checking user role:', error)
          setUserRole(null)
        } finally {
          setCheckingAuth(false)
        }
      } else if (isLoaded && !isSignedIn) {
        // Redirect if not signed in
        console.log('üîê User not signed in, redirecting to sign-in')
        router.push('/sign-in')
      } else {
        setCheckingAuth(false)
      }
    }

    checkUserRole()
  }, [isLoaded, isSignedIn, isClient, userId, router])

  // Enhanced File Upload Handler
  const handleFileUpload = async (
    file: File, 
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo', 
    moduleIndex?: number, 
    lessonIndex?: number
  ) => {
    const uploadId = type === 'lessonVideo' ? `lesson-${moduleIndex}-${lessonIndex}` : type
    
    try {
      const result = await uploadFile(file, type, uploadId)

      // Update form data based on upload type
      if (type === 'thumbnail') {
        setFormData(prev => ({
          ...prev,
          thumbnail: result
        }))
      } else if (type === 'previewVideo') {
        setFormData(prev => ({
          ...prev,
          previewVideo: result
        }))
      } else if (type === 'lessonVideo' && moduleIndex !== undefined && lessonIndex !== undefined) {
        const updatedModules = [...formData.modules]
        updatedModules[moduleIndex].lessons[lessonIndex].video = result
        setFormData(prev => ({ ...prev, modules: updatedModules }))
      }

    } catch (error) {
      console.error('Error uploading file:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to upload file. Please try again.'
      alert(errorMessage)
    }
  }

  const handleThumbnailChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'thumbnail')
    }
  }

  const handlePreviewVideoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'previewVideo')
    }
  }

  const handleLessonVideoChange = (e: React.ChangeEvent<HTMLInputElement>, moduleIndex: number, lessonIndex: number) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'lessonVideo', moduleIndex, lessonIndex)
    }
  }

  // Tag Management
  const addTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }))
      setNewTag('')
    }
  }

  const removeTag = (tagToRemove: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(tag => tag !== tagToRemove)
    }))
  }

  // Requirements & Outcomes
  const addRequirement = () => {
    if (newRequirement.trim()) {
      setFormData(prev => ({
        ...prev,
        requirements: [...prev.requirements, newRequirement.trim()]
      }))
      setNewRequirement('')
    }
  }

  const removeRequirement = (index: number) => {
    setFormData(prev => ({
      ...prev,
      requirements: prev.requirements.filter((_, i) => i !== index)
    }))
  }

  const addOutcome = () => {
    if (newOutcome.trim()) {
      setFormData(prev => ({
        ...prev,
        learningOutcomes: [...prev.learningOutcomes, newOutcome.trim()]
      }))
      setNewOutcome('')
    }
  }

  const removeOutcome = (index: number) => {
    setFormData(prev => ({
      ...prev,
      learningOutcomes: prev.learningOutcomes.filter((_, i) => i !== index)
    }))
  }

  // Module Management
  const addModule = () => {
    setFormData(prev => ({
      ...prev,
      modules: [...prev.modules, {
        title: '',
        description: '',
        lessons: [],
        order: prev.modules.length
      }]
    }))
  }

  const removeModule = (moduleIndex: number) => {
    setFormData(prev => ({
      ...prev,
      modules: prev.modules.filter((_, index) => index !== moduleIndex)
    }))
  }

  const addLesson = (moduleIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons.push({
      title: '',
      description: '',
      content: '',
      duration: 0,
      isPreview: false,
      resources: [],
      order: updatedModules[moduleIndex].lessons.length
    })
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const removeLesson = (moduleIndex: number, lessonIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons = updatedModules[moduleIndex].lessons.filter(
      (_, index) => index !== lessonIndex
    )
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const addResource = (moduleIndex: number, lessonIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons[lessonIndex].resources.push({
      title: '',
      url: '',
      type: 'pdf'
    })
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const removeResource = (moduleIndex: number, lessonIndex: number, resourceIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons[lessonIndex].resources = 
      updatedModules[moduleIndex].lessons[lessonIndex].resources.filter(
        (_, index) => index !== resourceIndex
      )
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  // Calculate upload stats
  const activeUploads = Object.values(uploadProgress).filter(
    upload => upload.status === 'generating-url' || upload.status === 'uploading'
  ).length

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // Check if any uploads are in progress
    const hasActiveUploads = Object.values(uploadProgress).some(
      upload => upload.status === 'generating-url' || upload.status === 'uploading'
    )
    
    if (hasActiveUploads) {
      alert('Please wait for all uploads to complete before submitting')
      return
    }

    setLoading(true)

    try {
      // Validate required fields
      if (!formData.thumbnail) {
        alert('Please upload a course thumbnail')
        return
      }

      // Validate all lessons have videos
      const missingVideos = formData.modules.some(module => 
        module.lessons.some(lesson => !lesson.video)
      )

      if (missingVideos) {
        alert('All lessons must have a video uploaded')
        return
      }

      console.log('üì§ Sending course data to API:', JSON.stringify(formData, null, 2))

      const response = await fetch('/api/admin/courses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      })

      const responseData = await response.json()
      
      if (response.ok) {
        console.log('‚úÖ Course created successfully:', responseData)
        router.push('/admin/courses')
        router.refresh()
      } else {
        console.error('‚ùå API Error response:', responseData)
        alert(responseData.error || responseData.details || 'Failed to create course')
      }
    } catch (error) {
      console.error('‚ùå Error creating course:', error)
      alert('Failed to create course. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  // Calculate totals
  const totalDuration = formData.modules.reduce((total, module) => {
    return total + module.lessons.reduce((moduleTotal, lesson) => moduleTotal + lesson.duration, 0)
  }, 0)

  const totalLessons = formData.modules.reduce((total, module) => total + module.lessons.length, 0)

  // Show loading state while checking auth and role
  if (!isLoaded || !isClient || checkingAuth) {
    return (
      <div className="p-6 max-w-7xl mx-auto flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="w-8 h-8 border-2 border-rose-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-slate-600">Checking permissions...</p>
          <p className="text-sm text-slate-500 mt-2">Verifying admin access</p>
        </div>
      </div>
    )
  }

  // Show nothing if not signed in (will redirect)
  if (!isSignedIn) {
    return null
  }

  // Check if user is admin from MongoDB role
  if (userRole !== 'admin') {
    return (
      <div className="p-6 max-w-7xl mx-auto flex items-center justify-center min-h-screen">
        <div className="text-center">
          <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
          <h2 className="text-2xl font-bold text-slate-900 mb-2">Access Denied</h2>
          <p className="text-slate-600 mb-4">
            {userRole === 'user' 
              ? 'Admin privileges required to access this page.' 
              : 'Unable to verify user permissions. Please try again.'
            }
          </p>
          <div className="space-y-2">
            <Button onClick={() => router.push('/')} className="w-full">
              Return to Home
            </Button>
            <Button variant="outline" onClick={() => window.location.reload()} className="w-full">
              Retry
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="p-6 max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-serif font-bold">Create New Course</h1>
          <p className="text-slate-600 dark:text-slate-400">
            Design and publish a comprehensive fashion course
          </p>
        </div>
        <Button 
          variant="outline" 
          className="rounded-2xl"
          onClick={() => router.back()}
        >
          Cancel
        </Button>
      </div>

      {/* Enhanced upload status banner */}
      {activeUploads > 0 && (
        <div className="space-y-3">
          <Card className="rounded-2xl border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-900/20">
            <CardContent className="p-4">
              <div className="flex items-center space-x-3">
                <CloudUpload className="w-5 h-5 text-blue-600" />
                <div className="flex-1">
                  <p className="text-sm font-medium text-blue-800 dark:text-blue-300">
                    Uploading {activeUploads} file{activeUploads > 1 ? 's' : ''} to AWS S3...
                  </p>
                  <p className="text-xs text-blue-600 dark:text-blue-400">
                    Large video support enabled ‚Ä¢ Do not close this page during upload
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
          
          {/* Show optimization tips for large files */}
          {Object.values(uploadProgress).map(upload => 
            upload.status === 'uploading' && uploadProgress[upload.fileName]?.progress < 100
          ).filter(Boolean).length > 0 && (
            <UploadOptimizationTips fileSize={1680.41 * 1024 * 1024} />
          )}
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Main Form */}
          <div className="lg:col-span-3 space-y-6">
            {/* Basic Information */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Information</CardTitle>
                <CardDescription>
                  Basic details about your course
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-4">
                    <Input
                      placeholder="Course Title *"
                      value={formData.title}
                      onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                      className="rounded-2xl"
                      required
                    />
                    
                    <Textarea
                      placeholder="Short Description *"
                      value={formData.shortDescription}
                      onChange={(e) => setFormData(prev => ({ ...prev, shortDescription: e.target.value }))}
                      className="rounded-2xl min-h-[80px]"
                      required
                    />
                  </div>
                  
                  <div className="space-y-4">
                    <select
                      value={formData.level}
                      onChange={(e) => setFormData(prev => ({ 
                        ...prev, 
                        level: e.target.value as 'beginner' | 'intermediate' | 'advanced' 
                      }))}
                      className="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2"
                      required
                    >
                      <option value="beginner">Beginner</option>
                      <option value="intermediate">Intermediate</option>
                      <option value="advanced">Advanced</option>
                    </select>
                    
                    <Input
                      placeholder="Category *"
                      value={formData.category}
                      onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                      className="rounded-2xl"
                      required
                    />
                  </div>
                </div>

                <Textarea
                  placeholder="Full Description *"
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                  className="rounded-2xl min-h-[120px]"
                  required
                />

                {/* Tags */}
                <div className="space-y-2">
                  <label className="text-sm font-medium">Tags</label>
                  <div className="flex flex-wrap gap-2 mb-2">
                    {formData.tags.map((tag, index) => (
                      <Badge key={index} variant="secondary" className="rounded-lg">
                        {tag}
                        <button
                          type="button"
                          onClick={() => removeTag(tag)}
                          className="ml-1 hover:text-red-500"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </Badge>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a tag"
                      value={newTag}
                      onChange={(e) => setNewTag(e.target.value)}
                      className="rounded-2xl flex-1"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addTag())}
                    />
                    <Button type="button" onClick={addTag} variant="outline" className="rounded-2xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Media Uploads */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Media</CardTitle>
                <CardDescription>
                  Upload thumbnail and preview video to AWS S3
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Thumbnail Upload */}
                  <FileUploadArea
                    type="thumbnail"
                    label="Course Thumbnail *"
                    acceptedFiles="image/jpeg,image/jpg,image/png,image/webp,image/gif"
                    maxSize="5MB"
                    currentFile={formData.thumbnail}
                    onFileChange={handleThumbnailChange}
                    uploadProgress={uploadProgress}
                    onCancelUpload={cancelUpload}
                  />

                  {/* Preview Video Upload */}
                  <FileUploadArea
                    type="previewVideo"
                    label="Preview Video (Optional)"
                    acceptedFiles="video/mp4,video/webm,video/ogg,video/quicktime,video/x-msvideo,video/avi,video/mkv,video/mov"
                    maxSize="5GB"
                    currentFile={formData.previewVideo}
                    onFileChange={handlePreviewVideoChange}
                    uploadProgress={uploadProgress}
                    onCancelUpload={cancelUpload}
                  />
                </div>
              </CardContent>
            </Card>

            {/* Requirements & Outcomes */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Requirements */}
              <Card className="rounded-2xl">
                <CardHeader>
                  <CardTitle className="text-lg">Requirements</CardTitle>
                  <CardDescription>
                    What students should know before taking this course
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {formData.requirements.map((requirement, index) => (
                    <div key={index} className="flex items-center space-x-2 p-2 bg-slate-50 dark:bg-slate-800 rounded-xl">
                      <div className="w-2 h-2 bg-rose-500 rounded-full flex-shrink-0"></div>
                      <span className="flex-1 text-sm">{requirement}</span>
                      <button
                        type="button"
                        onClick={() => removeRequirement(index)}
                        className="text-red-500 hover:text-red-600"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a requirement"
                      value={newRequirement}
                      onChange={(e) => setNewRequirement(e.target.value)}
                      className="rounded-xl text-sm"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addRequirement())}
                    />
                    <Button type="button" onClick={addRequirement} variant="outline" size="sm" className="rounded-xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Learning Outcomes */}
              <Card className="rounded-2xl">
                <CardHeader>
                  <CardTitle className="text-lg">Learning Outcomes</CardTitle>
                  <CardDescription>
                    What students will learn from this course
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {formData.learningOutcomes.map((outcome, index) => (
                    <div key={index} className="flex items-center space-x-2 p-2 bg-slate-50 dark:bg-slate-800 rounded-xl">
                      <div className="w-2 h-2 bg-green-500 rounded-full flex-shrink-0"></div>
                      <span className="flex-1 text-sm">{outcome}</span>
                      <button
                        type="button"
                        onClick={() => removeOutcome(index)}
                        className="text-red-500 hover:text-red-600"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a learning outcome"
                      value={newOutcome}
                      onChange={(e) => setNewOutcome(e.target.value)}
                      className="rounded-xl text-sm"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addOutcome())}
                    />
                    <Button type="button" onClick={addOutcome} variant="outline" size="sm" className="rounded-xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Course Content */}
            <Card className="rounded-2xl">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle>Course Content</CardTitle>
                    <CardDescription>
                      Add modules and lessons to your course
                    </CardDescription>
                  </div>
                  <Button type="button" onClick={addModule} variant="outline" className="rounded-2xl">
                    <Plus className="w-4 h-4 mr-2" />
                    Add Module
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="space-y-6">
                {formData.modules.map((module, moduleIndex) => (
                  <div key={moduleIndex} className="border border-slate-200 dark:border-slate-700 rounded-2xl p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center space-x-3 flex-1">
                        <div className="w-8 h-8 bg-rose-100 dark:bg-rose-900/30 rounded-lg flex items-center justify-center text-rose-600 font-bold text-sm">
                          {moduleIndex + 1}
                        </div>
                        <Input
                          placeholder="Module Title *"
                          value={module.title}
                          onChange={(e) => {
                            const updatedModules = [...formData.modules]
                            updatedModules[moduleIndex].title = e.target.value
                            setFormData(prev => ({ ...prev, modules: updatedModules }))
                          }}
                          className="rounded-2xl flex-1"
                          required
                        />
                      </div>
                      <Button 
                        type="button" 
                        variant="ghost" 
                        size="icon" 
                        onClick={() => removeModule(moduleIndex)}
                        className="text-red-500 rounded-2xl hover:text-red-600 hover:bg-red-50"
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                    
                    <Textarea
                      placeholder="Module Description *"
                      value={module.description}
                      onChange={(e) => {
                        const updatedModules = [...formData.modules]
                        updatedModules[moduleIndex].description = e.target.value
                        setFormData(prev => ({ ...prev, modules: updatedModules }))
                      }}
                      className="rounded-2xl mb-4"
                      required
                    />
                    
                    <div className="space-y-4">
                      {module.lessons.map((lesson, lessonIndex) => (
                        <div key={lessonIndex} className="border border-slate-200 dark:border-slate-600 rounded-2xl p-4">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center space-x-3 flex-1">
                              <div className="w-6 h-6 bg-slate-100 dark:bg-slate-700 rounded-md flex items-center justify-center text-slate-600 dark:text-slate-400 font-bold text-xs">
                                {lessonIndex + 1}
                              </div>
                              <Input
                                placeholder="Lesson Title *"
                                value={lesson.title}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].title = e.target.value
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded-2xl flex-1"
                                required
                              />
                            </div>
                            <Button 
                              type="button" 
                              variant="ghost" 
                              size="icon"
                              onClick={() => removeLesson(moduleIndex, lessonIndex)}
                              className="text-red-500 rounded-2xl hover:text-red-600 hover:bg-red-50"
                            >
                              <X className="w-4 h-4" />
                            </Button>
                          </div>

                          <Textarea
                            placeholder="Lesson Description *"
                            value={lesson.description}
                            onChange={(e) => {
                              const updatedModules = [...formData.modules]
                              updatedModules[moduleIndex].lessons[lessonIndex].description = e.target.value
                              setFormData(prev => ({ ...prev, modules: updatedModules }))
                            }}
                            className="rounded-2xl mb-3 min-h-[60px]"
                            required
                          />

                          {/* Video Upload */}
                          <div className="mb-3">
                            <FileUploadArea
                              type="lessonVideo"
                              label="Lesson Video *"
                              acceptedFiles="video/mp4,video/webm,video/ogg,video/quicktime,video/x-msvideo,video/avi,video/mkv,video/mov"
                              maxSize="5GB"
                              currentFile={lesson.video || null}
                              onFileChange={(e) => handleLessonVideoChange(e, moduleIndex, lessonIndex)}
                              moduleIndex={moduleIndex}
                              lessonIndex={lessonIndex}
                              uploadProgress={uploadProgress}
                              onCancelUpload={cancelUpload}
                            />
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                              <label className="text-sm font-medium mb-1 block">Duration (minutes)</label>
                              <Input
                                type="number"
                                placeholder="Duration"
                                value={lesson.duration}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].duration = parseInt(e.target.value) || 0
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded-2xl"
                                min="0"
                              />
                            </div>
                          </div>

                          <Textarea
                            placeholder="Lesson Content *"
                            value={lesson.content}
                            onChange={(e) => {
                              const updatedModules = [...formData.modules]
                              updatedModules[moduleIndex].lessons[lessonIndex].content = e.target.value
                              setFormData(prev => ({ ...prev, modules: updatedModules }))
                            }}
                            className="rounded-2xl mb-3 min-h-[100px]"
                            required
                          />

                          <div className="flex items-center justify-between mb-3">
                            <label className="flex items-center space-x-2">
                              <input
                                type="checkbox"
                                checked={lesson.isPreview}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].isPreview = e.target.checked
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded"
                              />
                              <span className="text-sm">Preview Lesson (Free to watch)</span>
                            </label>
                          </div>

                          {/* Resources */}
                          <div className="space-y-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-sm font-medium">Resources</h4>
                              <Button 
                                type="button" 
                                onClick={() => addResource(moduleIndex, lessonIndex)} 
                                variant="outline" 
                                size="sm" 
                                className="rounded-2xl"
                              >
                                <Plus className="w-3 h-3 mr-1" />
                                Add Resource
                              </Button>
                            </div>
                            
                            {lesson.resources.map((resource, resourceIndex) => (
                              <div key={resourceIndex} className="grid grid-cols-1 md:grid-cols-12 gap-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                                <Input
                                  placeholder="Resource Title"
                                  value={resource.title}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].title = e.target.value
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl md:col-span-4"
                                />
                                <Input
                                  placeholder="URL"
                                  value={resource.url}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].url = e.target.value
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl md:col-span-5"
                                />
                                <select
                                  value={resource.type}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].type = e.target.value as any
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-2 py-1 text-sm md:col-span-2"
                                >
                                  <option value="pdf">PDF</option>
                                  <option value="document">Document</option>
                                  <option value="link">Link</option>
                                  <option value="video">Video</option>
                                </select>
                                <Button 
                                  type="button" 
                                  variant="ghost" 
                                  size="icon"
                                  onClick={() => removeResource(moduleIndex, lessonIndex, resourceIndex)}
                                  className="text-red-500 rounded-xl hover:text-red-600 md:col-span-1"
                                >
                                  <X className="w-3 h-3" />
                                </Button>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                      
                      <Button 
                        type="button" 
                        onClick={() => addLesson(moduleIndex)} 
                        variant="outline" 
                        size="sm" 
                        className="rounded-2xl"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Add Lesson
                      </Button>
                    </div>
                  </div>
                ))}
              </CardContent>
            </Card>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Pricing */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Pricing</CardTitle>
                <CardDescription>
                  Set your course pricing
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center space-x-4">
                  <label className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      checked={formData.isFree}
                      onChange={(e) => setFormData(prev => ({ ...prev, isFree: e.target.checked }))}
                      className="rounded"
                    />
                    <span>Free Course</span>
                  </label>
                </div>
                
                {!formData.isFree && (
                  <div>
                    <label className="text-sm font-medium mb-1 block">Price ($)</label>
                    <Input
                      type="number"
                      placeholder="Price"
                      value={formData.price}
                      onChange={(e) => setFormData(prev => ({ ...prev, price: parseFloat(e.target.value) || 0 }))}
                      className="rounded-2xl"
                      min="0"
                      step="0.01"
                    />
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Course Settings */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Settings</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <label className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    checked={formData.isFeatured}
                    onChange={(e) => setFormData(prev => ({ ...prev, isFeatured: e.target.checked }))}
                    className="rounded"
                  />
                  <span>Feature this course</span>
                </label>
              </CardContent>
            </Card>

            {/* Course Summary */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Summary</CardTitle>
                <CardDescription>
                  Overview of your course
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Modules</span>
                  <span className="font-semibold">{formData.modules.length}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Lessons</span>
                  <span className="font-semibold">{totalLessons}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Total Duration</span>
                  <span className="font-semibold">{formatDuration(totalDuration)}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Price</span>
                  <span className="font-semibold">
                    {formData.isFree ? 'Free' : `$${formData.price}`}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Level</span>
                  <Badge variant="outline" className="rounded-full capitalize">
                    {formData.level}
                  </Badge>
                </div>
              </CardContent>
            </Card>

            {/* Actions */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Actions</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <Button 
                  type="submit" 
                  variant="premium" 
                  className="w-full rounded-2xl" 
                  disabled={loading || !formData.thumbnail || activeUploads > 0}
                >
                  {loading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                      Creating...
                    </>
                  ) : (
                    <>
                      <Save className="w-4 h-4 mr-2" />
                      Create Course
                    </>
                  )}
                </Button>
                
                <Button 
                  type="button" 
                  variant="outline" 
                  className="w-full rounded-2xl"
                  onClick={() => router.back()}
                >
                  Cancel
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </form>
    </div>
  )
}
----------------------------
// app/admin/courses/edit/[id]/page.tsx

'use client'

import { useState, useEffect, useRef } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { useAuth } from '@clerk/nextjs'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Progress } from '@/components/ui/progress'
import { 
  Plus, 
  Trash2, 
  Upload, 
  X, 
  Save, 
  BookOpen,
  Video,
  Image,
  FileText,
  Clock,
  Users,
  Star,
  Eye,
  EyeOff,
  Play,
  CheckCircle,
  AlertCircle,
  ArrowLeft,
  Loader2,
  CloudUpload
} from 'lucide-react'
import { useToast } from '@/components/ui/use-toast'

// Import the shared components and types from create page
import { S3Asset, UploadProgress, Lesson, Module, Course } from '@/types/course'

// File Upload Area Component
const FileUploadArea = ({
  type,
  label,
  acceptedFiles,
  maxSize,
  currentFile,
  onFileChange,
  moduleIndex,
  lessonIndex,
  uploadProgress,
  onCancelUpload
}: {
  type: 'thumbnail' | 'previewVideo' | 'lessonVideo'
  label: string
  acceptedFiles: string
  maxSize: string
  currentFile: S3Asset | null
  onFileChange: (e: React.ChangeEvent<HTMLInputElement>) => void
  moduleIndex?: number
  lessonIndex?: number
  uploadProgress?: UploadProgress
  onCancelUpload?: (identifier: string) => void
}) => {
  const inputRef = useRef<HTMLInputElement>(null)
  const uploadId = type === 'lessonVideo' ? `lesson-${moduleIndex}-${lessonIndex}` : type
  const upload = uploadProgress?.[uploadId]
  const isUploading = upload?.status === 'generating-url' || upload?.status === 'uploading'

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  const getStatusColor = () => {
    switch (upload?.status) {
      case 'generating-url': return 'bg-blue-500'
      case 'uploading': return 'bg-blue-500'
      case 'processing': return 'bg-yellow-500'
      case 'completed': return 'bg-green-500'
      case 'error': return 'bg-red-500'
      default: return 'bg-gray-500'
    }
  }

  const getStatusIcon = () => {
    switch (upload?.status) {
      case 'generating-url': return <CloudUpload className="w-4 h-4" />
      case 'uploading': return <CloudUpload className="w-4 h-4" />
      case 'processing': return <AlertCircle className="w-4 h-4" />
      case 'completed': return <CheckCircle className="w-4 h-4" />
      case 'error': return <AlertCircle className="w-4 h-4" />
      default: return <CloudUpload className="w-4 h-4" />
    }
  }

  const getStatusText = () => {
    switch (upload?.status) {
      case 'generating-url': return 'Preparing upload...'
      case 'uploading': return `Uploading... ${upload.progress}%`
      case 'processing': return 'Processing...'
      case 'completed': return 'Upload completed'
      case 'error': return 'Upload failed'
      default: return 'Uploading...'
    }
  }

  return (
    <div className="space-y-4">
      <label className="text-sm font-medium flex items-center space-x-2">
        {type === 'thumbnail' ? <Image className="w-4 h-4" /> : <Video className="w-4 h-4" />}
        <span>{label}</span>
      </label>
      
      <input
        ref={inputRef}
        type="file"
        accept={acceptedFiles}
        onChange={onFileChange}
        className="hidden"
        disabled={isUploading}
      />
      
      <div 
        className={`border-2 border-dashed rounded-2xl p-6 text-center cursor-pointer transition-colors ${
          isUploading 
            ? 'border-blue-300 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/20 cursor-not-allowed' 
            : 'border-slate-300 dark:border-slate-600 hover:border-rose-400'
        }`}
        onClick={() => !isUploading && inputRef.current?.click()}
      >
        {currentFile ? (
          <div className="space-y-2">
            {type === 'thumbnail' ? (
              <img
                src={currentFile.url}
                alt="Preview"
                className="w-32 h-32 object-cover rounded-xl mx-auto"
              />
            ) : (
              <div className="relative">
                <video className="w-32 h-32 object-cover rounded-xl mx-auto">
                  <source src={currentFile.url} type="video/mp4" />
                </video>
                <Play className="w-6 h-6 text-white absolute inset-0 m-auto" />
              </div>
            )}
            <p className="text-sm text-slate-600">Click to change</p>
            <p className="text-xs text-slate-500">
              {formatFileSize(currentFile.size)}
              {currentFile.duration && type !== 'thumbnail' && ` ‚Ä¢ ${currentFile.duration}s`}
            </p>
          </div>
        ) : (
          <div className="space-y-2">
            {type === 'thumbnail' ? (
              <Image className="w-8 h-8 text-slate-400 mx-auto" />
            ) : (
              <Video className="w-8 h-8 text-slate-400 mx-auto" />
            )}
            <p className="text-sm font-medium">
              {isUploading ? 'Uploading...' : `Upload ${type === 'thumbnail' ? 'Thumbnail' : 'Video'}`}
            </p>
            <p className="text-xs text-slate-500">
              {acceptedFiles.split(',').join(', ')} up to {maxSize}
            </p>
            {type !== 'thumbnail' && (
              <p className="text-xs text-blue-500 mt-1">
                Large files supported (up to 5GB)
              </p>
            )}
          </div>
        )}
      </div>
      
      {/* Upload Progress */}
      {upload && (
        <div className="flex items-center space-x-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
          <div className={`p-1 rounded-full ${getStatusColor()} text-white`}>
            {getStatusIcon()}
          </div>
          <div className="flex-1">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium truncate max-w-[200px]">
                {upload.fileName}
              </span>
              <span className="text-slate-500">
                {getStatusText()}
              </span>
            </div>
            {(upload.status === 'generating-url' || upload.status === 'uploading') && (
              <Progress value={upload.progress} className="h-2 mt-1" />
            )}
            {upload.status === 'error' && upload.error && (
              <p className="text-xs text-red-500 mt-1">{upload.error}</p>
            )}
          </div>
          {(upload.status === 'generating-url' || upload.status === 'uploading') && onCancelUpload && (
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => onCancelUpload(uploadId)}
              className="text-red-500 hover:text-red-600"
            >
              <X className="w-4 h-4" />
            </Button>
          )}
        </div>
      )}
    </div>
  )
}

// Upload Optimization Tips Component
const UploadOptimizationTips = ({ fileSize }: { fileSize: number }) => {
  const sizeInMB = fileSize / (1024 * 1024)
  
  return (
    <Card className="rounded-2xl border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-900/20">
      <CardContent className="p-4">
        <div className="flex items-start space-x-3">
          <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
          <div className="flex-1">
            <p className="text-sm font-medium text-yellow-800 dark:text-yellow-300 mb-2">
              Large File Upload in Progress ({sizeInMB.toFixed(2)}MB)
            </p>
            <ul className="text-xs text-yellow-700 dark:text-yellow-400 space-y-1">
              <li>‚Ä¢ Keep this page open during upload</li>
              <li>‚Ä¢ Use a stable internet connection</li>
              <li>‚Ä¢ Avoid uploading multiple large files simultaneously</li>
              <li>‚Ä¢ Upload time depends on your internet speed</li>
            </ul>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}

// Custom hook for S3 file uploads with Clerk auth
const useS3Upload = () => {
  const [uploadProgress, setUploadProgress] = useState<UploadProgress>({})
  const { getToken, userId } = useAuth()

  const uploadFile = async (
    file: File,
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo',
    identifier: string
  ) => {
    const maxSize = type === 'thumbnail' ? 5 * 1024 * 1024 : 5 * 1024 * 1024 * 1024
    if (file.size > maxSize) {
      throw new Error(
        `File too large. Maximum size: ${type === 'thumbnail' ? '5MB' : '5GB'}`
      )
    }

    // Calculate dynamic timeout (1 minute per 100MB + 10 minutes buffer)
    const timeoutDuration = Math.max(
      10 * 60 * 1000, // Minimum 10 minutes
      Math.ceil(file.size / (100 * 1024 * 1024)) * 60 * 1000 + 10 * 60 * 1000
    )

    try {
      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          progress: 0, 
          fileName: file.name, 
          type,
          status: 'generating-url'
        }
      }))

      console.log('üîê Getting Clerk token...')
      const token = await getToken()
      
      if (!token || !userId) {
        throw new Error('Authentication failed. Please sign in again.')
      }

      console.log('‚úÖ Token obtained, making upload request...')

      // Get presigned URL
      const presignedResponse = await fetch('/api/admin/upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          folder: `${type}s`
        }),
      })

      console.log('üì° Upload API response status:', presignedResponse.status)

      if (!presignedResponse.ok) {
        const errorText = await presignedResponse.text()
        let errorData
        try {
          errorData = JSON.parse(errorText)
        } catch {
          errorData = { error: 'Failed to get upload URL' }
        }
        throw new Error(errorData.error || `Upload failed with status: ${presignedResponse.status}`)
      }

      const { presignedUrl, fileUrl, fileKey } = await presignedResponse.json()

      console.log('‚úÖ Presigned URL received, starting upload...')
      console.log(`‚è∞ Using timeout: ${timeoutDuration / 1000 / 60} minutes for ${(file.size / (1024 * 1024)).toFixed(2)}MB file`)

      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          ...prev[identifier], 
          status: 'uploading',
          progress: 5
        }
      }))

      // Enhanced upload with better progress tracking
      const uploadResult = await new Promise<S3Asset>((resolve, reject) => {
        const xhr = new XMLHttpRequest()
        const uploadStartTime = Date.now()
        let lastProgressUpdate = Date.now()
        let lastLoaded = 0

        xhr.upload.addEventListener('progress', (event) => {
          if (event.lengthComputable) {
            const currentTime = Date.now()
            const progress = 5 + (event.loaded / event.total) * 90 // 5% to 95%
            
            // Calculate speed (only update every 500ms to reduce noise)
            if (currentTime - lastProgressUpdate > 500) {
              const timeDiff = (currentTime - lastProgressUpdate) / 1000
              const loadedDiff = event.loaded - lastLoaded
              const uploadSpeed = loadedDiff / timeDiff // bytes per second
              
              console.log(`üìä Upload progress: ${Math.round(progress)}% - Speed: ${(uploadSpeed / (1024 * 1024)).toFixed(2)} MB/s`)
              
              lastProgressUpdate = currentTime
              lastLoaded = event.loaded
            }

            setUploadProgress(prev => ({
              ...prev,
              [identifier]: { 
                ...prev[identifier], 
                progress: Math.round(progress)
              }
            }))
          }
        })

        xhr.addEventListener('load', () => {
          const uploadTime = (Date.now() - uploadStartTime) / 1000
          console.log(`‚úÖ Upload completed in ${uploadTime} seconds`)
          
          if (xhr.status === 200) {
            setUploadProgress(prev => ({
              ...prev,
              [identifier]: { 
                ...prev[identifier], 
                progress: 100,
                status: 'completed'
              }
            }))

            resolve({
              key: fileKey,
              url: fileUrl,
              size: file.size,
              type: type === 'thumbnail' ? 'image' : 'video',
              duration: type !== 'thumbnail' ? 0 : undefined
            })
          } else {
            console.error('‚ùå Upload failed with status:', xhr.status)
            reject(new Error(`Upload failed with status: ${xhr.status}`))
          }
        })

        xhr.addEventListener('error', (e) => {
          console.error('‚ùå Network error during upload:', e)
          reject(new Error('Network error during upload. Please check your connection.'))
        })

        xhr.addEventListener('abort', () => {
          console.error('‚ùå Upload was cancelled')
          reject(new Error('Upload was cancelled'))
        })

        // Set timeout and handle timeout gracefully
        xhr.timeout = timeoutDuration
        xhr.ontimeout = () => {
          const elapsed = (Date.now() - uploadStartTime) / 1000
          const uploadedMB = (lastLoaded / (1024 * 1024)).toFixed(2)
          console.error(`‚ùå Upload timeout after ${elapsed} seconds, uploaded: ${uploadedMB}MB`)
          reject(new Error(`Upload timeout after ${Math.round(elapsed / 60)} minutes. Uploaded ${uploadedMB}MB of ${(file.size / (1024 * 1024)).toFixed(2)}MB.`))
        }

        console.log('üì§ Starting direct upload to S3...')
        xhr.open('PUT', presignedUrl)
        xhr.setRequestHeader('Content-Type', file.type)
        // Remove unsafe headers - browser will set Content-Length automatically
        
        xhr.send(file)
      })

      // Clear progress after success
      setTimeout(() => {
        setUploadProgress(prev => {
          const newProgress = { ...prev }
          delete newProgress[identifier]
          return newProgress
        })
      }, 3000)

      return uploadResult

    } catch (error) {
      console.error('‚ùå Upload error:', error)
      setUploadProgress(prev => ({
        ...prev,
        [identifier]: { 
          ...prev[identifier], 
          status: 'error',
          error: error instanceof Error ? error.message : 'Upload failed'
        }
      }))
      throw error
    }
  }

  const cancelUpload = (identifier: string) => {
    console.log('üö´ Cancelling upload:', identifier)
    setUploadProgress(prev => {
      const newProgress = { ...prev }
      delete newProgress[identifier]
      return newProgress
    })
  }

  return { uploadProgress, uploadFile, cancelUpload }
}

export default function EditCoursePage() {
  const params = useParams()
  const router = useRouter()
  const { toast } = useToast()
  const { uploadProgress, uploadFile, cancelUpload } = useS3Upload()
  
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [course, setCourse] = useState<Course | null>(null)
  
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    shortDescription: '',
    price: 0,
    isFree: false,
    level: 'beginner' as 'beginner' | 'intermediate' | 'advanced',
    category: '',
    tags: [] as string[],
    thumbnail: null as S3Asset | null,
    previewVideo: null as S3Asset | null,
    modules: [] as Module[],
    requirements: [] as string[],
    learningOutcomes: [] as string[],
    isPublished: false,
    isFeatured: false
  })

  const [newTag, setNewTag] = useState('')
  const [newRequirement, setNewRequirement] = useState('')
  const [newOutcome, setNewOutcome] = useState('')

  // Calculate upload stats
  const activeUploads = Object.values(uploadProgress).filter(
    upload => upload.status === 'generating-url' || upload.status === 'uploading'
  ).length

  useEffect(() => {
    if (params.id) {
      fetchCourse()
    }
  }, [params.id])

  const fetchCourse = async () => {
    try {
      setLoading(true)
      const response = await fetch(`/api/admin/courses/${params.id}`)
      
      if (!response.ok) {
        throw new Error('Failed to fetch course')
      }

      const courseData = await response.json()
      setCourse(courseData)
      
      // Transform Cloudinary assets to S3 assets if needed
      const transformAsset = (asset: any): S3Asset | null => {
        if (!asset) return null
        return {
          key: asset.public_id || asset.key || '',
          url: asset.secure_url || asset.url || '',
          size: asset.bytes || asset.size || 0,
          type: asset.resource_type === 'image' ? 'image' : 'video',
          duration: asset.duration,
          width: asset.width,
          height: asset.height
        }
      }

      setFormData({
        title: courseData.title,
        description: courseData.description,
        shortDescription: courseData.shortDescription,
        price: courseData.price,
        isFree: courseData.isFree,
        level: courseData.level,
        category: courseData.category,
        tags: courseData.tags,
        thumbnail: transformAsset(courseData.thumbnail),
        previewVideo: transformAsset(courseData.previewVideo),
        modules: courseData.modules.map((module: any) => ({
          ...module,
          lessons: module.lessons.map((lesson: any) => ({
            ...lesson,
            video: transformAsset(lesson.video)
          }))
        })),
        requirements: courseData.requirements,
        learningOutcomes: courseData.learningOutcomes,
        isPublished: courseData.isPublished,
        isFeatured: courseData.isFeatured
      })
      
      toast({
        title: 'Success',
        description: 'Course loaded successfully!',
        variant: 'default'
      })
    } catch (err: any) {
      console.error('Error fetching course:', err)
      toast({
        title: 'Error',
        description: 'Failed to load course',
        variant: 'destructive'
      })
    } finally {
      setLoading(false)
    }
  }

  const handleFileUpload = async (
    file: File, 
    type: 'thumbnail' | 'previewVideo' | 'lessonVideo', 
    moduleIndex?: number, 
    lessonIndex?: number
  ) => {
    const uploadId = type === 'lessonVideo' ? `lesson-${moduleIndex}-${lessonIndex}` : type
    
    try {
      const result = await uploadFile(file, type, uploadId)

      // Update form data based on upload type
      if (type === 'thumbnail') {
        setFormData(prev => ({
          ...prev,
          thumbnail: result
        }))
      } else if (type === 'previewVideo') {
        setFormData(prev => ({
          ...prev,
          previewVideo: result
        }))
      } else if (type === 'lessonVideo' && moduleIndex !== undefined && lessonIndex !== undefined) {
        const updatedModules = [...formData.modules]
        updatedModules[moduleIndex].lessons[lessonIndex].video = result
        setFormData(prev => ({ ...prev, modules: updatedModules }))
      }

      toast({
        title: 'Success',
        description: `${type.replace(/([A-Z])/g, ' $1')} uploaded successfully!`,
        variant: 'default'
      })
    } catch (error) {
      console.error('Error uploading file:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to upload file. Please try again.'
      toast({
        title: 'Error',
        description: errorMessage,
        variant: 'destructive'
      })
    }
  }

  const handleThumbnailChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'thumbnail')
    }
  }

  const handlePreviewVideoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'previewVideo')
    }
  }

  const handleLessonVideoChange = (e: React.ChangeEvent<HTMLInputElement>, moduleIndex: number, lessonIndex: number) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file, 'lessonVideo', moduleIndex, lessonIndex)
    }
  }

  const addTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }))
      setNewTag('')
    }
  }

  const removeTag = (tagToRemove: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(tag => tag !== tagToRemove)
    }))
  }

  const addRequirement = () => {
    if (newRequirement.trim()) {
      setFormData(prev => ({
        ...prev,
        requirements: [...prev.requirements, newRequirement.trim()]
      }))
      setNewRequirement('')
    }
  }

  const removeRequirement = (index: number) => {
    setFormData(prev => ({
      ...prev,
      requirements: prev.requirements.filter((_, i) => i !== index)
    }))
  }

  const addOutcome = () => {
    if (newOutcome.trim()) {
      setFormData(prev => ({
        ...prev,
        learningOutcomes: [...prev.learningOutcomes, newOutcome.trim()]
      }))
      setNewOutcome('')
    }
  }

  const removeOutcome = (index: number) => {
    setFormData(prev => ({
      ...prev,
      learningOutcomes: prev.learningOutcomes.filter((_, i) => i !== index)
    }))
  }

  const addModule = () => {
    setFormData(prev => ({
      ...prev,
      modules: [...prev.modules, {
        title: '',
        description: '',
        lessons: [],
        order: prev.modules.length
      }]
    }))
  }

  const removeModule = (moduleIndex: number) => {
    setFormData(prev => ({
      ...prev,
      modules: prev.modules.filter((_, index) => index !== moduleIndex)
    }))
  }

  const addLesson = (moduleIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons.push({
      title: '',
      description: '',
      content: '',
      duration: 0,
      isPreview: false,
      resources: [],
      order: updatedModules[moduleIndex].lessons.length
    })
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const removeLesson = (moduleIndex: number, lessonIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons = updatedModules[moduleIndex].lessons.filter(
      (_, index) => index !== lessonIndex
    )
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const addResource = (moduleIndex: number, lessonIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons[lessonIndex].resources.push({
      title: '',
      url: '',
      type: 'pdf' as const
    })
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const removeResource = (moduleIndex: number, lessonIndex: number, resourceIndex: number) => {
    const updatedModules = [...formData.modules]
    updatedModules[moduleIndex].lessons[lessonIndex].resources = 
      updatedModules[moduleIndex].lessons[lessonIndex].resources.filter(
        (_, index) => index !== resourceIndex
      )
    setFormData(prev => ({ ...prev, modules: updatedModules }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // Check if any uploads are in progress
    const hasActiveUploads = Object.values(uploadProgress).some(
      upload => upload.status === 'generating-url' || upload.status === 'uploading'
    )
    
    if (hasActiveUploads) {
      toast({
        title: 'Error',
        description: 'Please wait for all uploads to complete before saving',
        variant: 'destructive'
      })
      return
    }

    setSaving(true)

    try {
      if (!formData.thumbnail) {
        toast({
          title: 'Error',
          description: 'Please upload a course thumbnail',
          variant: 'destructive'
        })
        return
      }

      const response = await fetch(`/api/admin/courses/${params.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      })

      if (response.ok) {
        toast({
          title: 'Success',
          description: 'Course updated successfully!',
          variant: 'default'
        })
        router.push('/admin/courses')
        router.refresh()
      } else {
        const error = await response.json()
        toast({
          title: 'Error',
          description: error.error || 'Failed to update course',
          variant: 'destructive'
        })
      }
    } catch (error) {
      console.error('Error updating course:', error)
      toast({
        title: 'Error',
        description: 'Failed to update course. Please try again.',
        variant: 'destructive'
      })
    } finally {
      setSaving(false)
    }
  }

  const togglePublish = async () => {
    try {
      const response = await fetch(`/api/admin/courses/${params.id}/publish`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          isPublished: !formData.isPublished
        }),
      })

      if (response.ok) {
        setFormData(prev => ({ ...prev, isPublished: !prev.isPublished }))
        toast({
          title: 'Success',
          description: formData.isPublished ? 'Course unpublished!' : 'Course published successfully!',
          variant: 'default'
        })
      } else {
        throw new Error('Failed to update publish status')
      }
    } catch (error) {
      console.error('Error toggling publish:', error)
      toast({
        title: 'Error',
        description: 'Failed to update publish status',
        variant: 'destructive'
      })
    }
  }

  const deleteCourse = async () => {
    if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
      return
    }

    try {
      const response = await fetch(`/api/admin/courses/${params.id}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        toast({
          title: 'Success',
          description: 'Course deleted successfully!',
          variant: 'default'
        })
        router.push('/admin/courses')
        router.refresh()
      } else {
        throw new Error('Failed to delete course')
      }
    } catch (error) {
      console.error('Error deleting course:', error)
      toast({
        title: 'Error',
        description: 'Failed to delete course',
        variant: 'destructive'
      })
    }
  }

  const totalDuration = formData.modules.reduce((total, module) => {
    return total + module.lessons.reduce((moduleTotal, lesson) => moduleTotal + lesson.duration, 0)
  }, 0)

  const totalLessons = formData.modules.reduce((total, module) => total + module.lessons.length, 0)

  const formatDuration = (minutes: number) => {
    const hours = Math.floor(minutes / 60)
    const mins = minutes % 60
    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`
  }

  if (loading) {
    return (
      <div className="p-6 flex justify-center items-center min-h-96">
        <Loader2 className="w-8 h-8 animate-spin text-rose-600" />
      </div>
    )
  }

  if (!course) {
    return (
      <div className="p-6 text-center">
        <h1 className="text-2xl font-bold mb-4">Course not found</h1>
        <Button onClick={() => router.push('/admin/courses')} variant="premium">
          Back to Courses
        </Button>
      </div>
    )
  }

  return (
    <div className="p-6 max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-4">
          <Button
            variant="outline"
            onClick={() => router.push('/admin/courses')}
            className="rounded-2xl"
          >
            <ArrowLeft className="w-4 h-4 mr-2" />
            Back
          </Button>
          <div>
            <h1 className="text-3xl font-serif font-bold">Edit Course</h1>
            <p className="text-slate-600 dark:text-slate-400">
              Update course details and content
            </p>
          </div>
        </div>
        <div className="flex items-center space-x-3">
          <Button 
            variant={formData.isPublished ? "outline" : "premium"}
            onClick={togglePublish}
            className="rounded-2xl"
          >
            {formData.isPublished ? (
              <>
                <EyeOff className="w-4 h-4 mr-2" />
                Unpublish
              </>
            ) : (
              <>
                <Eye className="w-4 h-4 mr-2" />
                Publish
              </>
            )}
          </Button>
          <Button 
            variant="destructive"
            onClick={deleteCourse}
            className="rounded-2xl"
          >
            <Trash2 className="w-4 h-4 mr-2" />
            Delete
          </Button>
        </div>
      </div>

      {/* Enhanced upload status banner */}
      {activeUploads > 0 && (
        <div className="space-y-3">
          <Card className="rounded-2xl border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-900/20">
            <CardContent className="p-4">
              <div className="flex items-center space-x-3">
                <CloudUpload className="w-5 h-5 text-blue-600" />
                <div className="flex-1">
                  <p className="text-sm font-medium text-blue-800 dark:text-blue-300">
                    Uploading {activeUploads} file{activeUploads > 1 ? 's' : ''} to AWS S3...
                  </p>
                  <p className="text-xs text-blue-600 dark:text-blue-400">
                    Large video support enabled ‚Ä¢ Do not close this page during upload
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
          
          {/* Show optimization tips for large files */}
          {Object.values(uploadProgress).map(upload => 
            upload.status === 'uploading' && uploadProgress[upload.fileName]?.progress < 100
          ).filter(Boolean).length > 0 && (
            <UploadOptimizationTips fileSize={1680.41 * 1024 * 1024} />
          )}
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Main Form */}
          <div className="lg:col-span-3 space-y-6">
            {/* Basic Information */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Information</CardTitle>
                <CardDescription>
                  Basic details about your course
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-4">
                    <Input
                      placeholder="Course Title *"
                      value={formData.title}
                      onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                      className="rounded-2xl"
                      required
                    />
                    
                    <Textarea
                      placeholder="Short Description *"
                      value={formData.shortDescription}
                      onChange={(e) => setFormData(prev => ({ ...prev, shortDescription: e.target.value }))}
                      className="rounded-2xl min-h-[80px]"
                      required
                    />
                  </div>
                  
                  <div className="space-y-4">
                    <select
                      value={formData.level}
                      onChange={(e) => setFormData(prev => ({ 
                        ...prev, 
                        level: e.target.value as 'beginner' | 'intermediate' | 'advanced' 
                      }))}
                      className="w-full rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2"
                      required
                    >
                      <option value="beginner">Beginner</option>
                      <option value="intermediate">Intermediate</option>
                      <option value="advanced">Advanced</option>
                    </select>
                    
                    <Input
                      placeholder="Category *"
                      value={formData.category}
                      onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                      className="rounded-2xl"
                      required
                    />
                  </div>
                </div>

                <Textarea
                  placeholder="Full Description *"
                  value={formData.description}
                  onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                  className="rounded-2xl min-h-[120px]"
                  required
                />

                {/* Tags */}
                <div className="space-y-2">
                  <label className="text-sm font-medium">Tags</label>
                  <div className="flex flex-wrap gap-2 mb-2">
                    {formData.tags.map((tag, index) => (
                      <Badge key={index} variant="secondary" className="rounded-lg">
                        {tag}
                        <button
                          type="button"
                          onClick={() => removeTag(tag)}
                          className="ml-1 hover:text-red-500"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </Badge>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a tag"
                      value={newTag}
                      onChange={(e) => setNewTag(e.target.value)}
                      className="rounded-2xl flex-1"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addTag())}
                    />
                    <Button type="button" onClick={addTag} variant="outline" className="rounded-2xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Media Uploads */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Media</CardTitle>
                <CardDescription>
                  Upload thumbnail and preview video to AWS S3
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Thumbnail Upload */}
                  <FileUploadArea
                    type="thumbnail"
                    label="Course Thumbnail *"
                    acceptedFiles="image/jpeg,image/jpg,image/png,image/webp,image/gif"
                    maxSize="5MB"
                    currentFile={formData.thumbnail}
                    onFileChange={handleThumbnailChange}
                    uploadProgress={uploadProgress}
                    onCancelUpload={cancelUpload}
                  />

                  {/* Preview Video Upload */}
                  <FileUploadArea
                    type="previewVideo"
                    label="Preview Video (Optional)"
                    acceptedFiles="video/mp4,video/webm,video/ogg,video/quicktime,video/x-msvideo,video/avi,video/mkv,video/mov"
                    maxSize="5GB"
                    currentFile={formData.previewVideo}
                    onFileChange={handlePreviewVideoChange}
                    uploadProgress={uploadProgress}
                    onCancelUpload={cancelUpload}
                  />
                </div>
              </CardContent>
            </Card>

            {/* Requirements & Outcomes */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Requirements */}
              <Card className="rounded-2xl">
                <CardHeader>
                  <CardTitle className="text-lg">Requirements</CardTitle>
                  <CardDescription>
                    What students should know before taking this course
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {formData.requirements.map((requirement, index) => (
                    <div key={index} className="flex items-center space-x-2 p-2 bg-slate-50 dark:bg-slate-800 rounded-xl">
                      <div className="w-2 h-2 bg-rose-500 rounded-full flex-shrink-0"></div>
                      <span className="flex-1 text-sm">{requirement}</span>
                      <button
                        type="button"
                        onClick={() => removeRequirement(index)}
                        className="text-red-500 hover:text-red-600"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a requirement"
                      value={newRequirement}
                      onChange={(e) => setNewRequirement(e.target.value)}
                      className="rounded-xl text-sm"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addRequirement())}
                    />
                    <Button type="button" onClick={addRequirement} variant="outline" size="sm" className="rounded-xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Learning Outcomes */}
              <Card className="rounded-2xl">
                <CardHeader>
                  <CardTitle className="text-lg">Learning Outcomes</CardTitle>
                  <CardDescription>
                    What students will learn from this course
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {formData.learningOutcomes.map((outcome, index) => (
                    <div key={index} className="flex items-center space-x-2 p-2 bg-slate-50 dark:bg-slate-800 rounded-xl">
                      <div className="w-2 h-2 bg-green-500 rounded-full flex-shrink-0"></div>
                      <span className="flex-1 text-sm">{outcome}</span>
                      <button
                        type="button"
                        onClick={() => removeOutcome(index)}
                        className="text-red-500 hover:text-red-600"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  ))}
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add a learning outcome"
                      value={newOutcome}
                      onChange={(e) => setNewOutcome(e.target.value)}
                      className="rounded-xl text-sm"
                      onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addOutcome())}
                    />
                    <Button type="button" onClick={addOutcome} variant="outline" size="sm" className="rounded-xl">
                      <Plus className="w-4 h-4" />
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Course Content */}
            <Card className="rounded-2xl">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle>Course Content</CardTitle>
                    <CardDescription>
                      Add modules and lessons to your course
                    </CardDescription>
                  </div>
                  <Button type="button" onClick={addModule} variant="outline" className="rounded-2xl">
                    <Plus className="w-4 h-4 mr-2" />
                    Add Module
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="space-y-6">
                {formData.modules.map((module, moduleIndex) => (
                  <div key={moduleIndex} className="border border-slate-200 dark:border-slate-700 rounded-2xl p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center space-x-3 flex-1">
                        <div className="w-8 h-8 bg-rose-100 dark:bg-rose-900/30 rounded-lg flex items-center justify-center text-rose-600 font-bold text-sm">
                          {moduleIndex + 1}
                        </div>
                        <Input
                          placeholder="Module Title *"
                          value={module.title}
                          onChange={(e) => {
                            const updatedModules = [...formData.modules]
                            updatedModules[moduleIndex].title = e.target.value
                            setFormData(prev => ({ ...prev, modules: updatedModules }))
                          }}
                          className="rounded-2xl flex-1"
                          required
                        />
                      </div>
                      <Button 
                        type="button" 
                        variant="ghost" 
                        size="icon" 
                        onClick={() => removeModule(moduleIndex)}
                        className="text-red-500 rounded-2xl hover:text-red-600 hover:bg-red-50"
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                    
                    <Textarea
                      placeholder="Module Description *"
                      value={module.description}
                      onChange={(e) => {
                        const updatedModules = [...formData.modules]
                        updatedModules[moduleIndex].description = e.target.value
                        setFormData(prev => ({ ...prev, modules: updatedModules }))
                      }}
                      className="rounded-2xl mb-4"
                      required
                    />
                    
                    <div className="space-y-4">
                      {module.lessons.map((lesson, lessonIndex) => (
                        <div key={lessonIndex} className="border border-slate-200 dark:border-slate-600 rounded-2xl p-4">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center space-x-3 flex-1">
                              <div className="w-6 h-6 bg-slate-100 dark:bg-slate-700 rounded-md flex items-center justify-center text-slate-600 dark:text-slate-400 font-bold text-xs">
                                {lessonIndex + 1}
                              </div>
                              <Input
                                placeholder="Lesson Title *"
                                value={lesson.title}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].title = e.target.value
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded-2xl flex-1"
                                required
                              />
                            </div>
                            <Button 
                              type="button" 
                              variant="ghost" 
                              size="icon"
                              onClick={() => removeLesson(moduleIndex, lessonIndex)}
                              className="text-red-500 rounded-2xl hover:text-red-600 hover:bg-red-50"
                            >
                              <X className="w-4 h-4" />
                            </Button>
                          </div>

                          <Textarea
                            placeholder="Lesson Description *"
                            value={lesson.description}
                            onChange={(e) => {
                              const updatedModules = [...formData.modules]
                              updatedModules[moduleIndex].lessons[lessonIndex].description = e.target.value
                              setFormData(prev => ({ ...prev, modules: updatedModules }))
                            }}
                            className="rounded-2xl mb-3 min-h-[60px]"
                            required
                          />

                          {/* Video Upload */}
                          <div className="mb-3">
                            <FileUploadArea
                              type="lessonVideo"
                              label="Lesson Video *"
                              acceptedFiles="video/mp4,video/webm,video/ogg,video/quicktime,video/x-msvideo,video/avi,video/mkv,video/mov"
                              maxSize="5GB"
                              currentFile={lesson.video || null}
                              onFileChange={(e) => handleLessonVideoChange(e, moduleIndex, lessonIndex)}
                              moduleIndex={moduleIndex}
                              lessonIndex={lessonIndex}
                              uploadProgress={uploadProgress}
                              onCancelUpload={cancelUpload}
                            />
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                              <label className="text-sm font-medium mb-1 block">Duration (minutes)</label>
                              <Input
                                type="number"
                                placeholder="Duration"
                                value={lesson.duration}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].duration = parseInt(e.target.value) || 0
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded-2xl"
                                min="0"
                              />
                            </div>
                          </div>

                          <Textarea
                            placeholder="Lesson Content *"
                            value={lesson.content}
                            onChange={(e) => {
                              const updatedModules = [...formData.modules]
                              updatedModules[moduleIndex].lessons[lessonIndex].content = e.target.value
                              setFormData(prev => ({ ...prev, modules: updatedModules }))
                            }}
                            className="rounded-2xl mb-3 min-h-[100px]"
                            required
                          />

                          <div className="flex items-center justify-between mb-3">
                            <label className="flex items-center space-x-2">
                              <input
                                type="checkbox"
                                checked={lesson.isPreview}
                                onChange={(e) => {
                                  const updatedModules = [...formData.modules]
                                  updatedModules[moduleIndex].lessons[lessonIndex].isPreview = e.target.checked
                                  setFormData(prev => ({ ...prev, modules: updatedModules }))
                                }}
                                className="rounded"
                              />
                              <span className="text-sm">Preview Lesson (Free to watch)</span>
                            </label>
                          </div>

                          {/* Resources */}
                          <div className="space-y-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-sm font-medium">Resources</h4>
                              <Button 
                                type="button" 
                                onClick={() => addResource(moduleIndex, lessonIndex)} 
                                variant="outline" 
                                size="sm" 
                                className="rounded-2xl"
                              >
                                <Plus className="w-3 h-3 mr-1" />
                                Add Resource
                              </Button>
                            </div>
                            
                            {lesson.resources.map((resource, resourceIndex) => (
                              <div key={resourceIndex} className="grid grid-cols-1 md:grid-cols-12 gap-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                                <Input
                                  placeholder="Resource Title"
                                  value={resource.title}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].title = e.target.value
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl md:col-span-4"
                                />
                                <Input
                                  placeholder="URL"
                                  value={resource.url}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].url = e.target.value
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl md:col-span-5"
                                />
                                <select
                                  value={resource.type}
                                  onChange={(e) => {
                                    const updatedModules = [...formData.modules]
                                    updatedModules[moduleIndex].lessons[lessonIndex].resources[resourceIndex].type = e.target.value as any
                                    setFormData(prev => ({ ...prev, modules: updatedModules }))
                                  }}
                                  className="rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-2 py-1 text-sm md:col-span-2"
                                >
                                  <option value="pdf">PDF</option>
                                  <option value="document">Document</option>
                                  <option value="link">Link</option>
                                  <option value="video">Video</option>
                                </select>
                                <Button 
                                  type="button" 
                                  variant="ghost" 
                                  size="icon"
                                  onClick={() => removeResource(moduleIndex, lessonIndex, resourceIndex)}
                                  className="text-red-500 rounded-xl hover:text-red-600 md:col-span-1"
                                >
                                  <X className="w-3 h-3" />
                                </Button>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                      
                      <Button 
                        type="button" 
                        onClick={() => addLesson(moduleIndex)} 
                        variant="outline" 
                        size="sm" 
                        className="rounded-2xl"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Add Lesson
                      </Button>
                    </div>
                  </div>
                ))}
              </CardContent>
            </Card>
          </div>

          {/* Sidebar */}
          <div className="space-y-6">
            {/* Pricing */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Pricing</CardTitle>
                <CardDescription>
                  Set your course pricing
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center space-x-4">
                  <label className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      checked={formData.isFree}
                      onChange={(e) => setFormData(prev => ({ ...prev, isFree: e.target.checked }))}
                      className="rounded"
                    />
                    <span>Free Course</span>
                  </label>
                </div>
                
                {!formData.isFree && (
                  <div>
                    <label className="text-sm font-medium mb-1 block">Price ($)</label>
                    <Input
                      type="number"
                      placeholder="Price"
                      value={formData.price}
                      onChange={(e) => setFormData(prev => ({ ...prev, price: parseFloat(e.target.value) || 0 }))}
                      className="rounded-2xl"
                      min="0"
                      step="0.01"
                    />
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Course Settings */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Settings</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <label className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    checked={formData.isFeatured}
                    onChange={(e) => setFormData(prev => ({ ...prev, isFeatured: e.target.checked }))}
                    className="rounded"
                  />
                  <span>Feature this course</span>
                </label>
              </CardContent>
            </Card>

            {/* Course Summary */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Summary</CardTitle>
                <CardDescription>
                  Overview of your course
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Modules</span>
                  <span className="font-semibold">{formData.modules.length}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Lessons</span>
                  <span className="font-semibold">{totalLessons}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Total Duration</span>
                  <span className="font-semibold">{formatDuration(totalDuration)}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Price</span>
                  <span className="font-semibold">
                    {formData.isFree ? 'Free' : `$${formData.price}`}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Level</span>
                  <Badge variant="outline" className="rounded-full capitalize">
                    {formData.level}
                  </Badge>
                </div>
              </CardContent>
            </Card>

            {/* Course Stats */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Course Stats</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Students</span>
                  <span className="font-semibold">{course.totalStudents}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Rating</span>
                  <div className="flex items-center space-x-1">
                    <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                    <span className="font-semibold">{course.averageRating.toFixed(1)}</span>
                  </div>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Duration</span>
                  <span className="font-semibold">{formatDuration(totalDuration)}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Lessons</span>
                  <span className="font-semibold">{totalLessons}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Modules</span>
                  <span className="font-semibold">{formData.modules.length}</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-slate-600">Status</span>
                  <Badge variant={formData.isPublished ? "success" : "secondary"} className="rounded-full">
                    {formData.isPublished ? 'Published' : 'Draft'}
                  </Badge>
                </div>
              </CardContent>
            </Card>

            {/* Actions */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>Actions</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <Button 
                  type="submit" 
                  variant="premium" 
                  className="w-full rounded-2xl" 
                  disabled={saving || !formData.thumbnail || activeUploads > 0}
                >
                  {saving ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin mr-2" />
                      Saving...
                    </>
                  ) : (
                    <>
                      <Save className="w-4 h-4 mr-2" />
                      Save Changes
                    </>
                  )}
                </Button>
                
                <Button 
                  type="button" 
                  variant="outline" 
                  className="w-full rounded-2xl"
                  onClick={() => router.push(`/courses/${course.slug}`)}
                >
                  <Eye className="w-4 h-4 mr-2" />
                  View Course
                </Button>

                <Button 
                  type="button" 
                  variant="outline" 
                  className="w-full rounded-2xl"
                  onClick={() => router.push('/admin/courses')}
                >
                  Cancel
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </form>
    </div>
  )
}
-----------------------
// app/admin/courses/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Search, Filter, Plus, Edit, Trash2, Eye, EyeOff, Users, Star } from 'lucide-react'
import Link from 'next/link'

interface Course {
  _id: string
  title: string
  description: string
  instructor: {
    username: string
    firstName: string
    lastName: string
    avatar: string
  }
  price: number
  isFree: boolean
  level: string
  category: string
  totalStudents: number
  averageRating: number
  isPublished: boolean
  createdAt: string
}

export default function AdminCoursesPage() {
  const [courses, setCourses] = useState<Course[]>([])
  const [loading, setLoading] = useState(true)
  const [searchQuery, setSearchQuery] = useState('')

  useEffect(() => {
    loadCourses()
  }, [])

  const loadCourses = async () => {
    try {
      const response = await fetch('/api/admin/courses')
      const data = await response.json()
      if (response.ok) {
        setCourses(data.courses)
      }
    } catch (error) {
      console.error('Error loading courses:', error)
    } finally {
      setLoading(false)
    }
  }

  const toggleCoursePublish = async (courseId: string, currentStatus: boolean) => {
    try {
      const response = await fetch(`/api/admin/courses/${courseId}/publish`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ isPublished: !currentStatus }),
      })

      if (response.ok) {
        setCourses(courses.map(course => 
          course._id === courseId ? { ...course, isPublished: !currentStatus } : course
        ))
      }
    } catch (error) {
      console.error('Error updating course publish status:', error)
    }
  }

  const deleteCourse = async (courseId: string) => {
    if (!confirm('Are you sure you want to delete this course?')) return

    try {
      const response = await fetch(`/api/admin/courses/${courseId}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        setCourses(courses.filter(course => course._id !== courseId))
      }
    } catch (error) {
      console.error('Error deleting course:', error)
    }
  }

  const filteredCourses = courses.filter(course =>
    course.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
    course.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
    course.instructor.username.toLowerCase().includes(searchQuery.toLowerCase()) ||
    course.category.toLowerCase().includes(searchQuery.toLowerCase())
  )

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-serif font-bold">Course Management</h1>
          <p className="text-slate-600 dark:text-slate-400">
            Manage and moderate platform courses
          </p>
        </div>
        <Link href="/admin/courses/create">
          <Button variant="premium" className="rounded-2xl">
            <Plus className="w-4 h-4 mr-2" />
            Create Course
          </Button>
        </Link>
      </div>

      {/* Search and Filters */}
      <Card className="rounded-2xl">
        <CardContent className="p-6">
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
              <Input
                type="text"
                placeholder="Search courses by title, description, or instructor..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-10 rounded-2xl"
              />
            </div>
            <Button variant="outline" className="rounded-2xl">
              <Filter className="w-4 h-4 mr-2" />
              Filters
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Courses Table */}
      <Card className="rounded-2xl">
        <CardHeader>
          <CardTitle>Courses ({filteredCourses.length})</CardTitle>
          <CardDescription>
            All courses on the platform
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {filteredCourses.map((course) => (
              <div key={course._id} className="flex items-start justify-between p-4 rounded-xl bg-slate-50 dark:bg-slate-800">
                <div className="flex items-start space-x-4 flex-1">
                  <div className="w-16 h-16 rounded-xl bg-gradient-to-r from-rose-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                    <Users className="w-6 h-6 text-white" />
                  </div>
                  
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-2 mb-2">
                      <h3 className="font-semibold text-lg">{course.title}</h3>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        course.level === 'beginner' 
                          ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                          : course.level === 'intermediate'
                          ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
                          : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'
                      }`}>
                        {course.level}
                      </span>
                    </div>
                    
                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-2 line-clamp-2">
                      {course.description}
                    </p>
                    
                    <div className="flex items-center space-x-4 text-xs text-slate-500">
                      <div className="flex items-center space-x-1">
                        <img
                          src={course.instructor.avatar || '/default-avatar.png'}
                          alt={course.instructor.username}
                          className="w-4 h-4 rounded-full"
                        />
                        <span>by {course.instructor.firstName} {course.instructor.lastName}</span>
                      </div>
                      <span>‚Ä¢</span>
                      <span>{course.category}</span>
                      <span>‚Ä¢</span>
                      <div className="flex items-center space-x-1">
                        <Users className="w-3 h-3" />
                        <span>{course.totalStudents} students</span>
                      </div>
                      <span>‚Ä¢</span>
                      <div className="flex items-center space-x-1">
                        <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                        <span>{course.averageRating || 'No ratings'}</span>
                      </div>
                      <span>‚Ä¢</span>
                      <span className={`px-2 py-1 rounded-full ${
                        course.isPublished 
                          ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                          : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
                      }`}>
                        {course.isPublished ? 'Published' : 'Draft'}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div className="flex items-center space-x-2">
                  <span className="text-lg font-bold text-rose-600">
                    {course.isFree ? 'Free' : `$${course.price}`}
                  </span>
                  
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => toggleCoursePublish(course._id, course.isPublished)}
                    className="rounded-xl"
                    title={course.isPublished ? 'Unpublish course' : 'Publish course'}
                  >
                    {course.isPublished ? (
                      <EyeOff className="w-4 h-4" />
                    ) : (
                      <Eye className="w-4 h-4" />
                    )}
                  </Button>
                  
                  <Link href={`/admin/courses/edit/${course._id}`}>
                    <Button variant="ghost" size="icon" className="rounded-xl">
                      <Edit className="w-4 h-4" />
                    </Button>
                  </Link>
                  
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => deleteCourse(course._id)}
                    className="rounded-xl text-red-500 hover:text-red-600"
                    title="Delete course"
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

give everything properly nice and clean and easy